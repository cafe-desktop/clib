
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Cppcheck - HTML report - clib (cppcheck 2.3-1)</title>
    <link rel="stylesheet" href="style.css">
    <style>
pre { line-height: 125%; margin: 0; }
td.linenos pre { color: #000000; background-color: #f0f0f0; padding: 0 5px 0 5px; }
span.linenos { color: #000000; background-color: #f0f0f0; padding: 0 5px 0 5px; }
td.linenos pre.special { color: #000000; background-color: #ffffc0; padding: 0 5px 0 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding: 0 5px 0 5px; }
.highlight .hll { background-color: #ffffcc }
.highlight { background: #ffffff; }
.highlight .c { color: #888888 } /* Comment */
.highlight .err { color: #FF0000; background-color: #FFAAAA } /* Error */
.highlight .k { color: #008800; font-weight: bold } /* Keyword */
.highlight .o { color: #333333 } /* Operator */
.highlight .ch { color: #888888 } /* Comment.Hashbang */
.highlight .cm { color: #888888 } /* Comment.Multiline */
.highlight .cp { color: #557799 } /* Comment.Preproc */
.highlight .cpf { color: #888888 } /* Comment.PreprocFile */
.highlight .c1 { color: #888888 } /* Comment.Single */
.highlight .cs { color: #cc0000; font-weight: bold } /* Comment.Special */
.highlight .gd { color: #A00000 } /* Generic.Deleted */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gr { color: #FF0000 } /* Generic.Error */
.highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.highlight .gi { color: #00A000 } /* Generic.Inserted */
.highlight .go { color: #888888 } /* Generic.Output */
.highlight .gp { color: #c65d09; font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.highlight .gt { color: #0044DD } /* Generic.Traceback */
.highlight .kc { color: #008800; font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: #008800; font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: #008800; font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: #003388; font-weight: bold } /* Keyword.Pseudo */
.highlight .kr { color: #008800; font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #333399; font-weight: bold } /* Keyword.Type */
.highlight .m { color: #6600EE; font-weight: bold } /* Literal.Number */
.highlight .s { background-color: #fff0f0 } /* Literal.String */
.highlight .na { color: #0000CC } /* Name.Attribute */
.highlight .nb { color: #007020 } /* Name.Builtin */
.highlight .nc { color: #BB0066; font-weight: bold } /* Name.Class */
.highlight .no { color: #003366; font-weight: bold } /* Name.Constant */
.highlight .nd { color: #555555; font-weight: bold } /* Name.Decorator */
.highlight .ni { color: #880000; font-weight: bold } /* Name.Entity */
.highlight .ne { color: #FF0000; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #0066BB; font-weight: bold } /* Name.Function */
.highlight .nl { color: #997700; font-weight: bold } /* Name.Label */
.highlight .nn { color: #0e84b5; font-weight: bold } /* Name.Namespace */
.highlight .nt { color: #007700 } /* Name.Tag */
.highlight .nv { color: #996633 } /* Name.Variable */
.highlight .ow { color: #000000; font-weight: bold } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mb { color: #6600EE; font-weight: bold } /* Literal.Number.Bin */
.highlight .mf { color: #6600EE; font-weight: bold } /* Literal.Number.Float */
.highlight .mh { color: #005588; font-weight: bold } /* Literal.Number.Hex */
.highlight .mi { color: #0000DD; font-weight: bold } /* Literal.Number.Integer */
.highlight .mo { color: #4400EE; font-weight: bold } /* Literal.Number.Oct */
.highlight .sa { background-color: #fff0f0 } /* Literal.String.Affix */
.highlight .sb { background-color: #fff0f0 } /* Literal.String.Backtick */
.highlight .sc { color: #0044DD } /* Literal.String.Char */
.highlight .dl { background-color: #fff0f0 } /* Literal.String.Delimiter */
.highlight .sd { color: #DD4422 } /* Literal.String.Doc */
.highlight .s2 { background-color: #fff0f0 } /* Literal.String.Double */
.highlight .se { color: #666666; font-weight: bold; background-color: #fff0f0 } /* Literal.String.Escape */
.highlight .sh { background-color: #fff0f0 } /* Literal.String.Heredoc */
.highlight .si { background-color: #eeeeee } /* Literal.String.Interpol */
.highlight .sx { color: #DD2200; background-color: #fff0f0 } /* Literal.String.Other */
.highlight .sr { color: #000000; background-color: #fff0ff } /* Literal.String.Regex */
.highlight .s1 { background-color: #fff0f0 } /* Literal.String.Single */
.highlight .ss { color: #AA6600 } /* Literal.String.Symbol */
.highlight .bp { color: #007020 } /* Name.Builtin.Pseudo */
.highlight .fm { color: #0066BB; font-weight: bold } /* Name.Function.Magic */
.highlight .vc { color: #336699 } /* Name.Variable.Class */
.highlight .vg { color: #dd7700; font-weight: bold } /* Name.Variable.Global */
.highlight .vi { color: #3333BB } /* Name.Variable.Instance */
.highlight .vm { color: #996633 } /* Name.Variable.Magic */
.highlight .il { color: #0000DD; font-weight: bold } /* Literal.Number.Integer.Long */
    </style>
    <script>
      function getStyle(el, styleProp) {
        var y;

        if (el.currentStyle) {
          y = el.currentStyle[styleProp];
        } else if (window.getComputedStyle) {
          y = document.defaultView.getComputedStyle(el, null).getPropertyValue(styleProp);
        }

        return y;
      }

      function toggle() {
        var el = this.expandable_content;
        var mark = this.expandable_marker;

        if (el.style.display === "block") {
          el.style.display = "none";
          mark.textContent = "[+]";
        } else {
          el.style.display = "block";
          mark.textContent = "[-]";
        }
      }

      function initExpandables() {
        var elements = document.querySelectorAll(".expandable");

        for (var i = 0, len = elements.length; i < len; i++) {
          var el = elements[i];
          var clickable = el.querySelector("span");
          var marker = clickable.querySelector(".marker");
          var content = el.querySelector(".content");
          var width = clickable.clientWidth - parseInt(getStyle(content, "padding-left")) - parseInt(getStyle(content, "padding-right"));
          content.style.width = width + "px";
          clickable.expandable_content = content;
          clickable.expandable_marker = marker;
          clickable.addEventListener("click", toggle);
        }
      }

      function toggleDisplay(id) {
        var elements = document.querySelectorAll("." + id);

        for (var i = 0, len = elements.length; i < len; i++) {
          elements[i].classList.toggle("d-none");
        }
      }

      function toggleAll() {
        var elements = document.querySelectorAll("input");

        // starting from 1 since 0 is the "toggle all" input
        for (var i = 1, len = elements.length; i < len; i++) {
          var el = elements[i];

          if (el.checked) {
            el.checked = false;
          } else {
            el.checked = true;
          }

          toggleDisplay(el.id);
        }
      }
      window.addEventListener("load", initExpandables);
    </script>
  </head>
  <body>
    <div id="header" class="header">
      <h1>Cppcheck report - clib (cppcheck 2.3-1): glib/gwin32.c</h1>
    </div>
    <div class="wrapper">
      <div id="menu">
       <p id="filename"><a href="index.html">Defects:</a> gwin32.c</p>
<a href="336.html#line-0"> toomanyconfigs 0</a>
    </div>
    <div id="content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>   1
   2
   3
   4
   5
   6
   7
   8
   9
  10
  11
  12
  13
  14
  15
  16
  17
  18
  19
  20
  21
  22
  23
  24
  25
  26
  27
  28
  29
  30
  31
  32
  33
  34
  35
  36
  37
  38
  39
  40
  41
  42
  43
  44
  45
  46
  47
  48
  49
  50
  51
  52
  53
  54
  55
  56
  57
  58
  59
  60
  61
  62
  63
  64
  65
  66
  67
  68
  69
  70
  71
  72
  73
  74
  75
  76
  77
  78
  79
  80
  81
  82
  83
  84
  85
  86
  87
  88
  89
  90
  91
  92
  93
  94
  95
  96
  97
  98
  99
 100
 101
 102
 103
 104
 105
 106
 107
 108
 109
 110
 111
 112
 113
 114
 115
 116
 117
 118
 119
 120
 121
 122
 123
 124
 125
 126
 127
 128
 129
 130
 131
 132
 133
 134
 135
 136
 137
 138
 139
 140
 141
 142
 143
 144
 145
 146
 147
 148
 149
 150
 151
 152
 153
 154
 155
 156
 157
 158
 159
 160
 161
 162
 163
 164
 165
 166
 167
 168
 169
 170
 171
 172
 173
 174
 175
 176
 177
 178
 179
 180
 181
 182
 183
 184
 185
 186
 187
 188
 189
 190
 191
 192
 193
 194
 195
 196
 197
 198
 199
 200
 201
 202
 203
 204
 205
 206
 207
 208
 209
 210
 211
 212
 213
 214
 215
 216
 217
 218
 219
 220
 221
 222
 223
 224
 225
 226
 227
 228
 229
 230
 231
 232
 233
 234
 235
 236
 237
 238
 239
 240
 241
 242
 243
 244
 245
 246
 247
 248
 249
 250
 251
 252
 253
 254
 255
 256
 257
 258
 259
 260
 261
 262
 263
 264
 265
 266
 267
 268
 269
 270
 271
 272
 273
 274
 275
 276
 277
 278
 279
 280
 281
 282
 283
 284
 285
 286
 287
 288
 289
 290
 291
 292
 293
 294
 295
 296
 297
 298
 299
 300
 301
 302
 303
 304
 305
 306
 307
 308
 309
 310
 311
 312
 313
 314
 315
 316
 317
 318
 319
 320
 321
 322
 323
 324
 325
 326
 327
 328
 329
 330
 331
 332
 333
 334
 335
 336
 337
 338
 339
 340
 341
 342
 343
 344
 345
 346
 347
 348
 349
 350
 351
 352
 353
 354
 355
 356
 357
 358
 359
 360
 361
 362
 363
 364
 365
 366
 367
 368
 369
 370
 371
 372
 373
 374
 375
 376
 377
 378
 379
 380
 381
 382
 383
 384
 385
 386
 387
 388
 389
 390
 391
 392
 393
 394
 395
 396
 397
 398
 399
 400
 401
 402
 403
 404
 405
 406
 407
 408
 409
 410
 411
 412
 413
 414
 415
 416
 417
 418
 419
 420
 421
 422
 423
 424
 425
 426
 427
 428
 429
 430
 431
 432
 433
 434
 435
 436
 437
 438
 439
 440
 441
 442
 443
 444
 445
 446
 447
 448
 449
 450
 451
 452
 453
 454
 455
 456
 457
 458
 459
 460
 461
 462
 463
 464
 465
 466
 467
 468
 469
 470
 471
 472
 473
 474
 475
 476
 477
 478
 479
 480
 481
 482
 483
 484
 485
 486
 487
 488
 489
 490
 491
 492
 493
 494
 495
 496
 497
 498
 499
 500
 501
 502
 503
 504
 505
 506
 507
 508
 509
 510
 511
 512
 513
 514
 515
 516
 517
 518
 519
 520
 521
 522
 523
 524
 525
 526
 527
 528
 529
 530
 531
 532
 533
 534
 535
 536
 537
 538
 539
 540
 541
 542
 543
 544
 545
 546
 547
 548
 549
 550
 551
 552
 553
 554
 555
 556
 557
 558
 559
 560
 561
 562
 563
 564
 565
 566
 567
 568
 569
 570
 571
 572
 573
 574
 575
 576
 577
 578
 579
 580
 581
 582
 583
 584
 585
 586
 587
 588
 589
 590
 591
 592
 593
 594
 595
 596
 597
 598
 599
 600
 601
 602
 603
 604
 605
 606
 607
 608
 609
 610
 611
 612
 613
 614
 615
 616
 617
 618
 619
 620
 621
 622
 623
 624
 625
 626
 627
 628
 629
 630
 631
 632
 633
 634
 635
 636
 637
 638
 639
 640
 641
 642
 643
 644
 645
 646
 647
 648
 649
 650
 651
 652
 653
 654
 655
 656
 657
 658
 659
 660
 661
 662
 663
 664
 665
 666
 667
 668
 669
 670
 671
 672
 673
 674
 675
 676
 677
 678
 679
 680
 681
 682
 683
 684
 685
 686
 687
 688
 689
 690
 691
 692
 693
 694
 695
 696
 697
 698
 699
 700
 701
 702
 703
 704
 705
 706
 707
 708
 709
 710
 711
 712
 713
 714
 715
 716
 717
 718
 719
 720
 721
 722
 723
 724
 725
 726
 727
 728
 729
 730
 731
 732
 733
 734
 735
 736
 737
 738
 739
 740
 741
 742
 743
 744
 745
 746
 747
 748
 749
 750
 751
 752
 753
 754
 755
 756
 757
 758
 759
 760
 761
 762
 763
 764
 765
 766
 767
 768
 769
 770
 771
 772
 773
 774
 775
 776
 777
 778
 779
 780
 781
 782
 783
 784
 785
 786
 787
 788
 789
 790
 791
 792
 793
 794
 795
 796
 797
 798
 799
 800
 801
 802
 803
 804
 805
 806
 807
 808
 809
 810
 811
 812
 813
 814
 815
 816
 817
 818
 819
 820
 821
 822
 823
 824
 825
 826
 827
 828
 829
 830
 831
 832
 833
 834
 835
 836
 837
 838
 839
 840
 841
 842
 843
 844
 845
 846
 847
 848
 849
 850
 851
 852
 853
 854
 855
 856
 857
 858
 859
 860
 861
 862
 863
 864
 865
 866
 867
 868
 869
 870
 871
 872
 873
 874
 875
 876
 877
 878
 879
 880
 881
 882
 883
 884
 885
 886
 887
 888
 889
 890
 891
 892
 893
 894
 895
 896
 897
 898
 899
 900
 901
 902
 903
 904
 905
 906
 907
 908
 909
 910
 911
 912
 913
 914
 915
 916
 917
 918
 919
 920
 921
 922
 923
 924
 925
 926
 927
 928
 929
 930
 931
 932
 933
 934
 935
 936
 937
 938
 939
 940
 941
 942
 943
 944
 945
 946
 947
 948
 949
 950
 951
 952
 953
 954
 955
 956
 957
 958
 959
 960
 961
 962
 963
 964
 965
 966
 967
 968
 969
 970
 971
 972
 973
 974
 975
 976
 977
 978
 979
 980
 981
 982
 983
 984
 985
 986
 987
 988
 989
 990
 991
 992
 993
 994
 995
 996
 997
 998
 999
1000
1001
1002
1003
1004
1005
1006
1007
1008
1009
1010
1011
1012
1013
1014
1015
1016
1017
1018
1019
1020
1021
1022
1023
1024
1025
1026
1027
1028
1029
1030
1031
1032
1033
1034
1035
1036
1037
1038
1039
1040
1041
1042
1043
1044
1045
1046
1047
1048
1049
1050
1051
1052
1053
1054
1055
1056
1057
1058
1059
1060
1061
1062
1063
1064
1065
1066
1067
1068
1069
1070
1071
1072
1073
1074
1075
1076
1077
1078
1079
1080
1081
1082
1083
1084
1085
1086
1087
1088
1089
1090
1091
1092
1093
1094
1095
1096
1097
1098
1099
1100
1101
1102
1103
1104
1105
1106
1107
1108
1109
1110
1111
1112
1113
1114
1115
1116
1117
1118
1119
1120
1121
1122
1123
1124
1125
1126
1127
1128
1129
1130
1131
1132
1133
1134
1135
1136
1137
1138
1139
1140
1141
1142
1143
1144
1145
1146
1147
1148
1149
1150
1151
1152
1153
1154
1155
1156
1157
1158
1159
1160
1161
1162
1163
1164
1165
1166
1167
1168
1169
1170
1171
1172
1173
1174
1175
1176
1177
1178
1179
1180
1181
1182
1183
1184
1185
1186
1187
1188
1189
1190
1191
1192
1193
1194
1195
1196
1197
1198
1199
1200
1201
1202
1203
1204
1205
1206
1207
1208
1209
1210
1211
1212
1213
1214
1215
1216
1217
1218
1219
1220
1221
1222
1223
1224
1225
1226
1227
1228
1229
1230
1231</pre></div></td><td class="code"><div class="highlight"><pre><span></span><a name="line-1"></a><span class="cm">/* GLIB - Library of useful routines for C programming</span>
<a name="line-2"></a><span class="cm"> * Copyright (C) 1995-1998  Peter Mattis, Spencer Kimball and Josh MacDonald</span>
<a name="line-3"></a><span class="cm"> * Copyright (C) 1998-1999  Tor Lillqvist</span>
<a name="line-4"></a><span class="cm"> *</span>
<a name="line-5"></a><span class="cm"> * This library is free software; you can redistribute it and/or</span>
<a name="line-6"></a><span class="cm"> * modify it under the terms of the GNU Lesser General Public</span>
<a name="line-7"></a><span class="cm"> * License as published by the Free Software Foundation; either</span>
<a name="line-8"></a><span class="cm"> * version 2.1 of the License, or (at your option) any later version.</span>
<a name="line-9"></a><span class="cm"> *</span>
<a name="line-10"></a><span class="cm"> * This library is distributed in the hope that it will be useful,</span>
<a name="line-11"></a><span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="line-12"></a><span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.	 See the GNU</span>
<a name="line-13"></a><span class="cm"> * Lesser General Public License for more details.</span>
<a name="line-14"></a><span class="cm"> *</span>
<a name="line-15"></a><span class="cm"> * You should have received a copy of the GNU Lesser General Public</span>
<a name="line-16"></a><span class="cm"> * License along with this library; if not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<a name="line-17"></a><span class="cm"> */</span>
<a name="line-18"></a>
<a name="line-19"></a><span class="cm">/*</span>
<a name="line-20"></a><span class="cm"> * Modified by the GLib Team and others 1997-2000.  See the AUTHORS</span>
<a name="line-21"></a><span class="cm"> * file for a list of people on the GLib Team.  See the ChangeLog</span>
<a name="line-22"></a><span class="cm"> * files for a list of changes.  These files are distributed with</span>
<a name="line-23"></a><span class="cm"> * GLib at ftp://ftp.ctk.org/pub/ctk/. </span>
<a name="line-24"></a><span class="cm"> */</span>
<a name="line-25"></a>
<a name="line-26"></a><span class="cm">/* </span>
<a name="line-27"></a><span class="cm"> * MT safe for the unix part, FIXME: make the win32 part MT safe as well.</span>
<a name="line-28"></a><span class="cm"> */</span>
<a name="line-29"></a>
<a name="line-30"></a><span class="cp">#include</span> <span class="cpf">&quot;config.h&quot;</span><span class="cp"></span>
<a name="line-31"></a>
<a name="line-32"></a><span class="cp">#include</span> <span class="cpf">&quot;glibconfig.h&quot;</span><span class="cp"></span>
<a name="line-33"></a>
<a name="line-34"></a><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<a name="line-35"></a><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<a name="line-36"></a><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>
<a name="line-37"></a><span class="cp">#include</span> <span class="cpf">&lt;wchar.h&gt;</span><span class="cp"></span>
<a name="line-38"></a><span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp"></span>
<a name="line-39"></a><span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp"></span>
<a name="line-40"></a>
<a name="line-41"></a><span class="cp">#define STRICT			</span><span class="cm">/* Strict typing, please */</span><span class="cp"></span>
<a name="line-42"></a><span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp"></span>
<a name="line-43"></a><span class="cp">#undef STRICT</span>
<a name="line-44"></a><span class="cp">#ifndef G_WITH_CYGWIN</span>
<a name="line-45"></a><span class="cp">#include</span> <span class="cpf">&lt;direct.h&gt;</span><span class="cp"></span>
<a name="line-46"></a><span class="cp">#endif</span>
<a name="line-47"></a><span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp"></span>
<a name="line-48"></a><span class="cp">#include</span> <span class="cpf">&lt;ctype.h&gt;</span><span class="cp"></span>
<a name="line-49"></a><span class="cp">#if defined(_MSC_VER) || defined(__DMC__)</span>
<a name="line-50"></a><span class="cp">#  include &lt;io.h&gt;</span>
<a name="line-51"></a><span class="cp">#endif </span><span class="cm">/* _MSC_VER || __DMC__ */</span><span class="cp"></span>
<a name="line-52"></a>
<a name="line-53"></a><span class="cp">#define MODERN_API_FAMILY 2</span>
<a name="line-54"></a>
<a name="line-55"></a><span class="cp">#if WINAPI_FAMILY == MODERN_API_FAMILY</span>
<a name="line-56"></a><span class="cm">/* This is for modern UI Builds, where we can&#39;t use LoadLibraryW()/GetProcAddress() */</span>
<a name="line-57"></a><span class="cm">/* ntddk.h is found in the WDK, and MinGW */</span>
<a name="line-58"></a><span class="cp">#include</span> <span class="cpf">&lt;ntddk.h&gt;</span><span class="cp"></span>
<a name="line-59"></a>
<a name="line-60"></a><span class="cp">#ifdef _MSC_VER</span>
<a name="line-61"></a><span class="cp">#pragma comment (lib, &quot;ntoskrnl.lib&quot;)</span>
<a name="line-62"></a><span class="cp">#endif</span>
<a name="line-63"></a><span class="cp">#elif defined(__MINGW32__) &amp;&amp; !defined(__MINGW64_VERSION_MAJOR)</span>
<a name="line-64"></a><span class="cm">/* mingw-w64 must use winternl.h, but not MinGW */</span>
<a name="line-65"></a><span class="cp">#include</span> <span class="cpf">&lt;ntdef.h&gt;</span><span class="cp"></span>
<a name="line-66"></a><span class="cp">#else</span>
<a name="line-67"></a><span class="cp">#include</span> <span class="cpf">&lt;winternl.h&gt;</span><span class="cp"></span>
<a name="line-68"></a><span class="cp">#endif</span>
<a name="line-69"></a>
<a name="line-70"></a><span class="cp">#include</span> <span class="cpf">&quot;glib.h&quot;</span><span class="cp"></span>
<a name="line-71"></a><span class="cp">#include</span> <span class="cpf">&quot;gthreadprivate.h&quot;</span><span class="cp"></span>
<a name="line-72"></a><span class="cp">#include</span> <span class="cpf">&quot;glib-init.h&quot;</span><span class="cp"></span>
<a name="line-73"></a>
<a name="line-74"></a><span class="cp">#ifdef G_WITH_CYGWIN</span>
<a name="line-75"></a><span class="cp">#include</span> <span class="cpf">&lt;sys/cygwin.h&gt;</span><span class="cp"></span>
<a name="line-76"></a><span class="cp">#endif</span>
<a name="line-77"></a>
<a name="line-78"></a><span class="cp">#ifndef G_WITH_CYGWIN</span>
<a name="line-79"></a>
<a name="line-80"></a><span class="n">gint</span>
<a name="line-81"></a><span class="nf">g_win32_ftruncate</span> <span class="p">(</span><span class="n">gint</span>  <span class="n">fd</span><span class="p">,</span>
<a name="line-82"></a>		   <span class="n">guint</span> <span class="n">size</span><span class="p">)</span>
<a name="line-83"></a><span class="p">{</span>
<a name="line-84"></a>  <span class="k">return</span> <span class="n">_chsize</span> <span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<a name="line-85"></a><span class="p">}</span>
<a name="line-86"></a>
<a name="line-87"></a><span class="cp">#endif</span>
<a name="line-88"></a>
<a name="line-89"></a><span class="cm">/**</span>
<a name="line-90"></a><span class="cm"> * g_win32_getlocale:</span>
<a name="line-91"></a><span class="cm"> *</span>
<a name="line-92"></a><span class="cm"> * The setlocale() function in the Microsoft C library uses locale</span>
<a name="line-93"></a><span class="cm"> * names of the form &quot;English_United States.1252&quot; etc. We want the</span>
<a name="line-94"></a><span class="cm"> * UNIXish standard form &quot;en_US&quot;, &quot;zh_TW&quot; etc. This function gets the</span>
<a name="line-95"></a><span class="cm"> * current thread locale from Windows - without any encoding info -</span>
<a name="line-96"></a><span class="cm"> * and returns it as a string of the above form for use in forming</span>
<a name="line-97"></a><span class="cm"> * file names etc. The returned string should be deallocated with</span>
<a name="line-98"></a><span class="cm"> * g_free().</span>
<a name="line-99"></a><span class="cm"> *</span>
<a name="line-100"></a><span class="cm"> * Returns: newly-allocated locale name.</span>
<a name="line-101"></a><span class="cm"> **/</span>
<a name="line-102"></a>
<a name="line-103"></a><span class="cp">#ifndef SUBLANG_SERBIAN_LATIN_BA</span>
<a name="line-104"></a><span class="cp">#define SUBLANG_SERBIAN_LATIN_BA 0x06</span>
<a name="line-105"></a><span class="cp">#endif</span>
<a name="line-106"></a>
<a name="line-107"></a><span class="n">gchar</span> <span class="o">*</span>
<a name="line-108"></a><span class="nf">g_win32_getlocale</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<a name="line-109"></a><span class="p">{</span>
<a name="line-110"></a>  <span class="n">LCID</span> <span class="n">lcid</span><span class="p">;</span>
<a name="line-111"></a>  <span class="n">LANGID</span> <span class="n">langid</span><span class="p">;</span>
<a name="line-112"></a>  <span class="k">const</span> <span class="n">gchar</span> <span class="o">*</span><span class="n">ev</span><span class="p">;</span>
<a name="line-113"></a>  <span class="n">gint</span> <span class="n">primary</span><span class="p">,</span> <span class="n">sub</span><span class="p">;</span>
<a name="line-114"></a>  <span class="kt">char</span> <span class="n">iso639</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
<a name="line-115"></a>  <span class="kt">char</span> <span class="n">iso3166</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
<a name="line-116"></a>  <span class="k">const</span> <span class="n">gchar</span> <span class="o">*</span><span class="n">script</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="line-117"></a>
<a name="line-118"></a>  <span class="cm">/* Let the user override the system settings through environment</span>
<a name="line-119"></a><span class="cm">   * variables, as on POSIX systems. Note that in CTK+ applications</span>
<a name="line-120"></a><span class="cm">   * since CTK+ 2.10.7 setting either LC_ALL or LANG also sets the</span>
<a name="line-121"></a><span class="cm">   * Win32 locale and C library locale through code in ctkmain.c.</span>
<a name="line-122"></a><span class="cm">   */</span>
<a name="line-123"></a>  <span class="k">if</span> <span class="p">(((</span><span class="n">ev</span> <span class="o">=</span> <span class="n">g_getenv</span> <span class="p">(</span><span class="s">&quot;LC_ALL&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">ev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
<a name="line-124"></a>      <span class="o">||</span> <span class="p">((</span><span class="n">ev</span> <span class="o">=</span> <span class="n">g_getenv</span> <span class="p">(</span><span class="s">&quot;LC_MESSAGES&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">ev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
<a name="line-125"></a>      <span class="o">||</span> <span class="p">((</span><span class="n">ev</span> <span class="o">=</span> <span class="n">g_getenv</span> <span class="p">(</span><span class="s">&quot;LANG&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">ev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">))</span>
<a name="line-126"></a>    <span class="k">return</span> <span class="n">g_strdup</span> <span class="p">(</span><span class="n">ev</span><span class="p">);</span>
<a name="line-127"></a>
<a name="line-128"></a>  <span class="n">lcid</span> <span class="o">=</span> <span class="n">GetThreadLocale</span> <span class="p">();</span>
<a name="line-129"></a>
<a name="line-130"></a>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">GetLocaleInfo</span> <span class="p">(</span><span class="n">lcid</span><span class="p">,</span> <span class="n">LOCALE_SISO639LANGNAME</span><span class="p">,</span> <span class="n">iso639</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">iso639</span><span class="p">))</span> <span class="o">||</span>
<a name="line-131"></a>      <span class="o">!</span><span class="n">GetLocaleInfo</span> <span class="p">(</span><span class="n">lcid</span><span class="p">,</span> <span class="n">LOCALE_SISO3166CTRYNAME</span><span class="p">,</span> <span class="n">iso3166</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">iso3166</span><span class="p">)))</span>
<a name="line-132"></a>    <span class="k">return</span> <span class="n">g_strdup</span> <span class="p">(</span><span class="s">&quot;C&quot;</span><span class="p">);</span>
<a name="line-133"></a>  
<a name="line-134"></a>  <span class="cm">/* Strip off the sorting rules, keep only the language part.  */</span>
<a name="line-135"></a>  <span class="n">langid</span> <span class="o">=</span> <span class="n">LANGIDFROMLCID</span> <span class="p">(</span><span class="n">lcid</span><span class="p">);</span>
<a name="line-136"></a>
<a name="line-137"></a>  <span class="cm">/* Split into language and territory part.  */</span>
<a name="line-138"></a>  <span class="n">primary</span> <span class="o">=</span> <span class="n">PRIMARYLANGID</span> <span class="p">(</span><span class="n">langid</span><span class="p">);</span>
<a name="line-139"></a>  <span class="n">sub</span> <span class="o">=</span> <span class="n">SUBLANGID</span> <span class="p">(</span><span class="n">langid</span><span class="p">);</span>
<a name="line-140"></a>
<a name="line-141"></a>  <span class="cm">/* Handle special cases */</span>
<a name="line-142"></a>  <span class="k">switch</span> <span class="p">(</span><span class="n">primary</span><span class="p">)</span>
<a name="line-143"></a>    <span class="p">{</span>
<a name="line-144"></a>    <span class="k">case</span> <span class="nl">LANG_AZERI</span><span class="p">:</span>
<a name="line-145"></a>      <span class="k">switch</span> <span class="p">(</span><span class="n">sub</span><span class="p">)</span>
<a name="line-146"></a>	<span class="p">{</span>
<a name="line-147"></a>	<span class="k">case</span> <span class="nl">SUBLANG_AZERI_LATIN</span><span class="p">:</span>
<a name="line-148"></a>	  <span class="n">script</span> <span class="o">=</span> <span class="s">&quot;@Latn&quot;</span><span class="p">;</span>
<a name="line-149"></a>	  <span class="k">break</span><span class="p">;</span>
<a name="line-150"></a>	<span class="k">case</span> <span class="nl">SUBLANG_AZERI_CYRILLIC</span><span class="p">:</span>
<a name="line-151"></a>	  <span class="n">script</span> <span class="o">=</span> <span class="s">&quot;@Cyrl&quot;</span><span class="p">;</span>
<a name="line-152"></a>	  <span class="k">break</span><span class="p">;</span>
<a name="line-153"></a>	<span class="p">}</span>
<a name="line-154"></a>      <span class="k">break</span><span class="p">;</span>
<a name="line-155"></a>    <span class="k">case</span> <span class="nl">LANG_SERBIAN</span><span class="p">:</span>		<span class="cm">/* LANG_CROATIAN == LANG_SERBIAN */</span>
<a name="line-156"></a>      <span class="k">switch</span> <span class="p">(</span><span class="n">sub</span><span class="p">)</span>
<a name="line-157"></a>	<span class="p">{</span>
<a name="line-158"></a>	<span class="k">case</span> <span class="nl">SUBLANG_SERBIAN_LATIN</span><span class="p">:</span>
<a name="line-159"></a>	<span class="k">case</span> <span class="mh">0x06</span><span class="o">:</span> <span class="cm">/* Serbian (Latin) - Bosnia and Herzegovina */</span>
<a name="line-160"></a>	  <span class="n">script</span> <span class="o">=</span> <span class="s">&quot;@Latn&quot;</span><span class="p">;</span>
<a name="line-161"></a>	  <span class="k">break</span><span class="p">;</span>
<a name="line-162"></a>	<span class="p">}</span>
<a name="line-163"></a>      <span class="k">break</span><span class="p">;</span>
<a name="line-164"></a>    <span class="k">case</span> <span class="nl">LANG_UZBEK</span><span class="p">:</span>
<a name="line-165"></a>      <span class="k">switch</span> <span class="p">(</span><span class="n">sub</span><span class="p">)</span>
<a name="line-166"></a>	<span class="p">{</span>
<a name="line-167"></a>	<span class="k">case</span> <span class="nl">SUBLANG_UZBEK_LATIN</span><span class="p">:</span>
<a name="line-168"></a>	  <span class="n">script</span> <span class="o">=</span> <span class="s">&quot;@Latn&quot;</span><span class="p">;</span>
<a name="line-169"></a>	  <span class="k">break</span><span class="p">;</span>
<a name="line-170"></a>	<span class="k">case</span> <span class="nl">SUBLANG_UZBEK_CYRILLIC</span><span class="p">:</span>
<a name="line-171"></a>	  <span class="n">script</span> <span class="o">=</span> <span class="s">&quot;@Cyrl&quot;</span><span class="p">;</span>
<a name="line-172"></a>	  <span class="k">break</span><span class="p">;</span>
<a name="line-173"></a>	<span class="p">}</span>
<a name="line-174"></a>      <span class="k">break</span><span class="p">;</span>
<a name="line-175"></a>    <span class="p">}</span>
<a name="line-176"></a>  <span class="k">return</span> <span class="n">g_strconcat</span> <span class="p">(</span><span class="n">iso639</span><span class="p">,</span> <span class="s">&quot;_&quot;</span><span class="p">,</span> <span class="n">iso3166</span><span class="p">,</span> <span class="n">script</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<a name="line-177"></a><span class="p">}</span>
<a name="line-178"></a>
<a name="line-179"></a><span class="cm">/**</span>
<a name="line-180"></a><span class="cm"> * g_win32_error_message:</span>
<a name="line-181"></a><span class="cm"> * @error: error code.</span>
<a name="line-182"></a><span class="cm"> *</span>
<a name="line-183"></a><span class="cm"> * Translate a Win32 error code (as returned by GetLastError() or</span>
<a name="line-184"></a><span class="cm"> * WSAGetLastError()) into the corresponding message. The message is</span>
<a name="line-185"></a><span class="cm"> * either language neutral, or in the thread&#39;s language, or the user&#39;s</span>
<a name="line-186"></a><span class="cm"> * language, the system&#39;s language, or US English (see docs for</span>
<a name="line-187"></a><span class="cm"> * FormatMessage()). The returned string is in UTF-8. It should be</span>
<a name="line-188"></a><span class="cm"> * deallocated with g_free().</span>
<a name="line-189"></a><span class="cm"> *</span>
<a name="line-190"></a><span class="cm"> * Returns: newly-allocated error message</span>
<a name="line-191"></a><span class="cm"> **/</span>
<a name="line-192"></a><span class="n">gchar</span> <span class="o">*</span>
<a name="line-193"></a><span class="nf">g_win32_error_message</span> <span class="p">(</span><span class="n">gint</span> <span class="n">error</span><span class="p">)</span>
<a name="line-194"></a><span class="p">{</span>
<a name="line-195"></a>  <span class="n">gchar</span> <span class="o">*</span><span class="n">retval</span><span class="p">;</span>
<a name="line-196"></a>  <span class="kt">wchar_t</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="line-197"></a>  <span class="kt">size_t</span> <span class="n">nchars</span><span class="p">;</span>
<a name="line-198"></a>
<a name="line-199"></a>  <span class="n">FormatMessageW</span> <span class="p">(</span><span class="n">FORMAT_MESSAGE_ALLOCATE_BUFFER</span>
<a name="line-200"></a>		  <span class="o">|</span><span class="n">FORMAT_MESSAGE_IGNORE_INSERTS</span>
<a name="line-201"></a>		  <span class="o">|</span><span class="n">FORMAT_MESSAGE_FROM_SYSTEM</span><span class="p">,</span>
<a name="line-202"></a>		  <span class="nb">NULL</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
<a name="line-203"></a>		  <span class="p">(</span><span class="n">LPWSTR</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<a name="line-204"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">msg</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
<a name="line-205"></a>    <span class="p">{</span>
<a name="line-206"></a>      <span class="n">nchars</span> <span class="o">=</span> <span class="n">wcslen</span> <span class="p">(</span><span class="n">msg</span><span class="p">);</span>
<a name="line-207"></a>
<a name="line-208"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">nchars</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">msg</span><span class="p">[</span><span class="n">nchars</span><span class="mi">-1</span><span class="p">]</span> <span class="o">==</span> <span class="sa">L</span><span class="sc">&#39;\n&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">msg</span><span class="p">[</span><span class="n">nchars</span><span class="mi">-2</span><span class="p">]</span> <span class="o">==</span> <span class="sa">L</span><span class="sc">&#39;\r&#39;</span><span class="p">)</span>
<a name="line-209"></a>        <span class="n">msg</span><span class="p">[</span><span class="n">nchars</span><span class="mi">-2</span><span class="p">]</span> <span class="o">=</span> <span class="sa">L</span><span class="sc">&#39;\0&#39;</span><span class="p">;</span>
<a name="line-210"></a>
<a name="line-211"></a>      <span class="n">retval</span> <span class="o">=</span> <span class="n">g_utf16_to_utf8</span> <span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">-1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<a name="line-212"></a>
<a name="line-213"></a>      <span class="n">LocalFree</span> <span class="p">(</span><span class="n">msg</span><span class="p">);</span>
<a name="line-214"></a>    <span class="p">}</span>
<a name="line-215"></a>  <span class="k">else</span>
<a name="line-216"></a>    <span class="n">retval</span> <span class="o">=</span> <span class="n">g_strdup</span> <span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>
<a name="line-217"></a>
<a name="line-218"></a>  <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<a name="line-219"></a><span class="p">}</span>
<a name="line-220"></a>
<a name="line-221"></a><span class="cm">/**</span>
<a name="line-222"></a><span class="cm"> * g_win32_get_package_installation_directory_of_module:</span>
<a name="line-223"></a><span class="cm"> * @hmodule: (nullable): The Win32 handle for a DLL loaded into the current process, or %NULL</span>
<a name="line-224"></a><span class="cm"> *</span>
<a name="line-225"></a><span class="cm"> * This function tries to determine the installation directory of a</span>
<a name="line-226"></a><span class="cm"> * software package based on the location of a DLL of the software</span>
<a name="line-227"></a><span class="cm"> * package.</span>
<a name="line-228"></a><span class="cm"> *</span>
<a name="line-229"></a><span class="cm"> * @hmodule should be the handle of a loaded DLL or %NULL. The</span>
<a name="line-230"></a><span class="cm"> * function looks up the directory that DLL was loaded from. If</span>
<a name="line-231"></a><span class="cm"> * @hmodule is NULL, the directory the main executable of the current</span>
<a name="line-232"></a><span class="cm"> * process is looked up. If that directory&#39;s last component is &quot;bin&quot;</span>
<a name="line-233"></a><span class="cm"> * or &quot;lib&quot;, its parent directory is returned, otherwise the directory</span>
<a name="line-234"></a><span class="cm"> * itself.</span>
<a name="line-235"></a><span class="cm"> *</span>
<a name="line-236"></a><span class="cm"> * It thus makes sense to pass only the handle to a &quot;public&quot; DLL of a</span>
<a name="line-237"></a><span class="cm"> * software package to this function, as such DLLs typically are known</span>
<a name="line-238"></a><span class="cm"> * to be installed in a &quot;bin&quot; or occasionally &quot;lib&quot; subfolder of the</span>
<a name="line-239"></a><span class="cm"> * installation folder. DLLs that are of the dynamically loaded module</span>
<a name="line-240"></a><span class="cm"> * or plugin variety are often located in more private locations</span>
<a name="line-241"></a><span class="cm"> * deeper down in the tree, from which it is impossible for GLib to</span>
<a name="line-242"></a><span class="cm"> * deduce the root of the package installation.</span>
<a name="line-243"></a><span class="cm"> *</span>
<a name="line-244"></a><span class="cm"> * The typical use case for this function is to have a DllMain() that</span>
<a name="line-245"></a><span class="cm"> * saves the handle for the DLL. Then when code in the DLL needs to</span>
<a name="line-246"></a><span class="cm"> * construct names of files in the installation tree it calls this</span>
<a name="line-247"></a><span class="cm"> * function passing the DLL handle.</span>
<a name="line-248"></a><span class="cm"> *</span>
<a name="line-249"></a><span class="cm"> * Returns: a string containing the guessed installation directory for</span>
<a name="line-250"></a><span class="cm"> * the software package @hmodule is from. The string is in the GLib</span>
<a name="line-251"></a><span class="cm"> * file name encoding, i.e. UTF-8. The return value should be freed</span>
<a name="line-252"></a><span class="cm"> * with g_free() when not needed any longer. If the function fails</span>
<a name="line-253"></a><span class="cm"> * %NULL is returned.</span>
<a name="line-254"></a><span class="cm"> *</span>
<a name="line-255"></a><span class="cm"> * Since: 2.16</span>
<a name="line-256"></a><span class="cm"> */</span>
<a name="line-257"></a><span class="n">gchar</span> <span class="o">*</span>
<a name="line-258"></a><span class="nf">g_win32_get_package_installation_directory_of_module</span> <span class="p">(</span><span class="n">gpointer</span> <span class="n">hmodule</span><span class="p">)</span>
<a name="line-259"></a><span class="p">{</span>
<a name="line-260"></a>  <span class="n">gchar</span> <span class="o">*</span><span class="n">filename</span><span class="p">;</span>
<a name="line-261"></a>  <span class="n">gchar</span> <span class="o">*</span><span class="n">retval</span><span class="p">;</span>
<a name="line-262"></a>  <span class="n">gchar</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
<a name="line-263"></a>  <span class="kt">wchar_t</span> <span class="n">wc_fn</span><span class="p">[</span><span class="n">MAX_PATH</span><span class="p">];</span>
<a name="line-264"></a>
<a name="line-265"></a>  <span class="cm">/* NOTE: it relies that GetModuleFileNameW returns only canonical paths */</span>
<a name="line-266"></a>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">GetModuleFileNameW</span> <span class="p">(</span><span class="n">hmodule</span><span class="p">,</span> <span class="n">wc_fn</span><span class="p">,</span> <span class="n">MAX_PATH</span><span class="p">))</span>
<a name="line-267"></a>    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="line-268"></a>
<a name="line-269"></a>  <span class="n">filename</span> <span class="o">=</span> <span class="n">g_utf16_to_utf8</span> <span class="p">(</span><span class="n">wc_fn</span><span class="p">,</span> <span class="mi">-1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<a name="line-270"></a>
<a name="line-271"></a>  <span class="k">if</span> <span class="p">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">strrchr</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">G_DIR_SEPARATOR</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
<a name="line-272"></a>    <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
<a name="line-273"></a>
<a name="line-274"></a>  <span class="n">retval</span> <span class="o">=</span> <span class="n">g_strdup</span> <span class="p">(</span><span class="n">filename</span><span class="p">);</span>
<a name="line-275"></a>
<a name="line-276"></a>  <span class="k">do</span>
<a name="line-277"></a>    <span class="p">{</span>
<a name="line-278"></a>      <span class="n">p</span> <span class="o">=</span> <span class="n">strrchr</span> <span class="p">(</span><span class="n">retval</span><span class="p">,</span> <span class="n">G_DIR_SEPARATOR</span><span class="p">);</span>
<a name="line-279"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
<a name="line-280"></a>        <span class="k">break</span><span class="p">;</span>
<a name="line-281"></a>
<a name="line-282"></a>      <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
<a name="line-283"></a>
<a name="line-284"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">g_ascii_strcasecmp</span> <span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;bin&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
<a name="line-285"></a>          <span class="n">g_ascii_strcasecmp</span> <span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;lib&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="line-286"></a>        <span class="k">break</span><span class="p">;</span>
<a name="line-287"></a>    <span class="p">}</span>
<a name="line-288"></a>  <span class="k">while</span> <span class="p">(</span><span class="n">p</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
<a name="line-289"></a>
<a name="line-290"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
<a name="line-291"></a>    <span class="p">{</span>
<a name="line-292"></a>      <span class="n">g_free</span> <span class="p">(</span><span class="n">retval</span><span class="p">);</span>
<a name="line-293"></a>      <span class="n">retval</span> <span class="o">=</span> <span class="n">filename</span><span class="p">;</span>
<a name="line-294"></a>    <span class="p">}</span>
<a name="line-295"></a>  <span class="k">else</span>
<a name="line-296"></a>    <span class="n">g_free</span> <span class="p">(</span><span class="n">filename</span><span class="p">);</span>
<a name="line-297"></a>
<a name="line-298"></a><span class="cp">#ifdef G_WITH_CYGWIN</span>
<a name="line-299"></a>  <span class="cm">/* In Cygwin we need to have POSIX paths */</span>
<a name="line-300"></a>  <span class="p">{</span>
<a name="line-301"></a>    <span class="n">gchar</span> <span class="n">tmp</span><span class="p">[</span><span class="n">MAX_PATH</span><span class="p">];</span>
<a name="line-302"></a>
<a name="line-303"></a>    <span class="n">cygwin_conv_to_posix_path</span> <span class="p">(</span><span class="n">retval</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
<a name="line-304"></a>    <span class="n">g_free</span> <span class="p">(</span><span class="n">retval</span><span class="p">);</span>
<a name="line-305"></a>    <span class="n">retval</span> <span class="o">=</span> <span class="n">g_strdup</span> <span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
<a name="line-306"></a>  <span class="p">}</span>
<a name="line-307"></a><span class="cp">#endif</span>
<a name="line-308"></a>
<a name="line-309"></a>  <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<a name="line-310"></a><span class="p">}</span>
<a name="line-311"></a>
<a name="line-312"></a><span class="k">static</span> <span class="n">gchar</span> <span class="o">*</span>
<a name="line-313"></a><span class="n">get_package_directory_from_module</span> <span class="p">(</span><span class="k">const</span> <span class="n">gchar</span> <span class="o">*</span><span class="n">module_name</span><span class="p">)</span>
<a name="line-314"></a><span class="p">{</span>
<a name="line-315"></a>  <span class="k">static</span> <span class="n">GHashTable</span> <span class="o">*</span><span class="n">module_dirs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="line-316"></a>  <span class="n">G_LOCK_DEFINE_STATIC</span> <span class="p">(</span><span class="n">module_dirs</span><span class="p">);</span>
<a name="line-317"></a>  <span class="n">HMODULE</span> <span class="n">hmodule</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="line-318"></a>  <span class="n">gchar</span> <span class="o">*</span><span class="n">fn</span><span class="p">;</span>
<a name="line-319"></a>
<a name="line-320"></a>  <span class="n">G_LOCK</span> <span class="p">(</span><span class="n">module_dirs</span><span class="p">);</span>
<a name="line-321"></a>
<a name="line-322"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">module_dirs</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
<a name="line-323"></a>    <span class="n">module_dirs</span> <span class="o">=</span> <span class="n">g_hash_table_new</span> <span class="p">(</span><span class="n">g_str_hash</span><span class="p">,</span> <span class="n">g_str_equal</span><span class="p">);</span>
<a name="line-324"></a>  
<a name="line-325"></a>  <span class="n">fn</span> <span class="o">=</span> <span class="n">g_hash_table_lookup</span> <span class="p">(</span><span class="n">module_dirs</span><span class="p">,</span> <span class="n">module_name</span> <span class="o">?</span> <span class="nl">module_name</span> <span class="p">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
<a name="line-326"></a>      
<a name="line-327"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">fn</span><span class="p">)</span>
<a name="line-328"></a>    <span class="p">{</span>
<a name="line-329"></a>      <span class="n">G_UNLOCK</span> <span class="p">(</span><span class="n">module_dirs</span><span class="p">);</span>
<a name="line-330"></a>      <span class="k">return</span> <span class="nf">g_strdup</span> <span class="p">(</span><span class="n">fn</span><span class="p">);</span>
<a name="line-331"></a>    <span class="p">}</span>
<a name="line-332"></a>
<a name="line-333"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">module_name</span><span class="p">)</span>
<a name="line-334"></a>    <span class="p">{</span>
<a name="line-335"></a>      <span class="kt">wchar_t</span> <span class="o">*</span><span class="n">wc_module_name</span> <span class="o">=</span> <span class="n">g_utf8_to_utf16</span> <span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="mi">-1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<a name="line-336"></a>      <span class="n">hmodule</span> <span class="o">=</span> <span class="n">GetModuleHandleW</span> <span class="p">(</span><span class="n">wc_module_name</span><span class="p">);</span>
<a name="line-337"></a>      <span class="n">g_free</span> <span class="p">(</span><span class="n">wc_module_name</span><span class="p">);</span>
<a name="line-338"></a>
<a name="line-339"></a>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hmodule</span><span class="p">)</span>
<a name="line-340"></a>	<span class="p">{</span>
<a name="line-341"></a>	  <span class="n">G_UNLOCK</span> <span class="p">(</span><span class="n">module_dirs</span><span class="p">);</span>
<a name="line-342"></a>	  <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="line-343"></a>	<span class="p">}</span>
<a name="line-344"></a>    <span class="p">}</span>
<a name="line-345"></a>
<a name="line-346"></a>  <span class="n">fn</span> <span class="o">=</span> <span class="n">g_win32_get_package_installation_directory_of_module</span> <span class="p">(</span><span class="n">hmodule</span><span class="p">);</span>
<a name="line-347"></a>
<a name="line-348"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">fn</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
<a name="line-349"></a>    <span class="p">{</span>
<a name="line-350"></a>      <span class="n">G_UNLOCK</span> <span class="p">(</span><span class="n">module_dirs</span><span class="p">);</span>
<a name="line-351"></a>      <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="line-352"></a>    <span class="p">}</span>
<a name="line-353"></a>  
<a name="line-354"></a>  <span class="n">g_hash_table_insert</span> <span class="p">(</span><span class="n">module_dirs</span><span class="p">,</span> <span class="n">module_name</span> <span class="o">?</span> <span class="n">g_strdup</span> <span class="p">(</span><span class="n">module_name</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">fn</span><span class="p">);</span>
<a name="line-355"></a>
<a name="line-356"></a>  <span class="n">G_UNLOCK</span> <span class="p">(</span><span class="n">module_dirs</span><span class="p">);</span>
<a name="line-357"></a>
<a name="line-358"></a>  <span class="k">return</span> <span class="nf">g_strdup</span> <span class="p">(</span><span class="n">fn</span><span class="p">);</span>
<a name="line-359"></a><span class="p">}</span>
<a name="line-360"></a>
<a name="line-361"></a><span class="cm">/**</span>
<a name="line-362"></a><span class="cm"> * g_win32_get_package_installation_directory:</span>
<a name="line-363"></a><span class="cm"> * @package: (nullable): You should pass %NULL for this.</span>
<a name="line-364"></a><span class="cm"> * @dll_name: (nullable): The name of a DLL that a package provides in UTF-8, or %NULL.</span>
<a name="line-365"></a><span class="cm"> *</span>
<a name="line-366"></a><span class="cm"> * Try to determine the installation directory for a software package.</span>
<a name="line-367"></a><span class="cm"> *</span>
<a name="line-368"></a><span class="cm"> * This function is deprecated. Use</span>
<a name="line-369"></a><span class="cm"> * g_win32_get_package_installation_directory_of_module() instead.</span>
<a name="line-370"></a><span class="cm"> *</span>
<a name="line-371"></a><span class="cm"> * The use of @package is deprecated. You should always pass %NULL. A</span>
<a name="line-372"></a><span class="cm"> * warning is printed if non-NULL is passed as @package.</span>
<a name="line-373"></a><span class="cm"> *</span>
<a name="line-374"></a><span class="cm"> * The original intended use of @package was for a short identifier of</span>
<a name="line-375"></a><span class="cm"> * the package, typically the same identifier as used for</span>
<a name="line-376"></a><span class="cm"> * `GETTEXT_PACKAGE` in software configured using GNU</span>
<a name="line-377"></a><span class="cm"> * autotools. The function first looks in the Windows Registry for the</span>
<a name="line-378"></a><span class="cm"> * value `#InstallationDirectory` in the key</span>
<a name="line-379"></a><span class="cm"> * `#HKLM\Software\@package`, and if that value</span>
<a name="line-380"></a><span class="cm"> * exists and is a string, returns that.</span>
<a name="line-381"></a><span class="cm"> *</span>
<a name="line-382"></a><span class="cm"> * It is strongly recommended that packagers of GLib-using libraries</span>
<a name="line-383"></a><span class="cm"> * for Windows do not store installation paths in the Registry to be</span>
<a name="line-384"></a><span class="cm"> * used by this function as that interfers with having several</span>
<a name="line-385"></a><span class="cm"> * parallel installations of the library. Enabling multiple</span>
<a name="line-386"></a><span class="cm"> * installations of different versions of some GLib-using library, or</span>
<a name="line-387"></a><span class="cm"> * GLib itself, is desirable for various reasons.</span>
<a name="line-388"></a><span class="cm"> *</span>
<a name="line-389"></a><span class="cm"> * For this reason it is recommended to always pass %NULL as</span>
<a name="line-390"></a><span class="cm"> * @package to this function, to avoid the temptation to use the</span>
<a name="line-391"></a><span class="cm"> * Registry. In version 2.20 of GLib the @package parameter</span>
<a name="line-392"></a><span class="cm"> * will be ignored and this function won&#39;t look in the Registry at all.</span>
<a name="line-393"></a><span class="cm"> *</span>
<a name="line-394"></a><span class="cm"> * If @package is %NULL, or the above value isn&#39;t found in the</span>
<a name="line-395"></a><span class="cm"> * Registry, but @dll_name is non-%NULL, it should name a DLL loaded</span>
<a name="line-396"></a><span class="cm"> * into the current process. Typically that would be the name of the</span>
<a name="line-397"></a><span class="cm"> * DLL calling this function, looking for its installation</span>
<a name="line-398"></a><span class="cm"> * directory. The function then asks Windows what directory that DLL</span>
<a name="line-399"></a><span class="cm"> * was loaded from. If that directory&#39;s last component is &quot;bin&quot; or</span>
<a name="line-400"></a><span class="cm"> * &quot;lib&quot;, the parent directory is returned, otherwise the directory</span>
<a name="line-401"></a><span class="cm"> * itself. If that DLL isn&#39;t loaded, the function proceeds as if</span>
<a name="line-402"></a><span class="cm"> * @dll_name was %NULL.</span>
<a name="line-403"></a><span class="cm"> *</span>
<a name="line-404"></a><span class="cm"> * If both @package and @dll_name are %NULL, the directory from where</span>
<a name="line-405"></a><span class="cm"> * the main executable of the process was loaded is used instead in</span>
<a name="line-406"></a><span class="cm"> * the same way as above.</span>
<a name="line-407"></a><span class="cm"> *</span>
<a name="line-408"></a><span class="cm"> * Returns: a string containing the installation directory for</span>
<a name="line-409"></a><span class="cm"> * @package. The string is in the GLib file name encoding,</span>
<a name="line-410"></a><span class="cm"> * i.e. UTF-8. The return value should be freed with g_free() when not</span>
<a name="line-411"></a><span class="cm"> * needed any longer. If the function fails %NULL is returned.</span>
<a name="line-412"></a><span class="cm"> *</span>
<a name="line-413"></a><span class="cm"> * Deprecated: 2.18: Pass the HMODULE of a DLL or EXE to</span>
<a name="line-414"></a><span class="cm"> * g_win32_get_package_installation_directory_of_module() instead.</span>
<a name="line-415"></a><span class="cm"> **/</span>
<a name="line-416"></a>
<a name="line-417"></a><span class="n">gchar</span> <span class="o">*</span>
<a name="line-418"></a><span class="n">g_win32_get_package_installation_directory</span> <span class="p">(</span><span class="k">const</span> <span class="n">gchar</span> <span class="o">*</span><span class="n">package</span><span class="p">,</span>
<a name="line-419"></a>                                            <span class="k">const</span> <span class="n">gchar</span> <span class="o">*</span><span class="n">dll_name</span><span class="p">)</span>
<a name="line-420"></a><span class="p">{</span>
<a name="line-421"></a>  <span class="n">gchar</span> <span class="o">*</span><span class="n">result</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="line-422"></a>
<a name="line-423"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">package</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
<a name="line-424"></a>      <span class="n">g_warning</span> <span class="p">(</span><span class="s">&quot;Passing a non-NULL package to g_win32_get_package_installation_directory() is deprecated and it is ignored.&quot;</span><span class="p">);</span>
<a name="line-425"></a>
<a name="line-426"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">dll_name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
<a name="line-427"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">get_package_directory_from_module</span> <span class="p">(</span><span class="n">dll_name</span><span class="p">);</span>
<a name="line-428"></a>
<a name="line-429"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
<a name="line-430"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">get_package_directory_from_module</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
<a name="line-431"></a>
<a name="line-432"></a>  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<a name="line-433"></a><span class="p">}</span>
<a name="line-434"></a>
<a name="line-435"></a><span class="cm">/**</span>
<a name="line-436"></a><span class="cm"> * g_win32_get_package_installation_subdirectory:</span>
<a name="line-437"></a><span class="cm"> * @package: (nullable): You should pass %NULL for this.</span>
<a name="line-438"></a><span class="cm"> * @dll_name: (nullable): The name of a DLL that a package provides, in UTF-8, or %NULL.</span>
<a name="line-439"></a><span class="cm"> * @subdir: A subdirectory of the package installation directory, also in UTF-8</span>
<a name="line-440"></a><span class="cm"> *</span>
<a name="line-441"></a><span class="cm"> * This function is deprecated. Use</span>
<a name="line-442"></a><span class="cm"> * g_win32_get_package_installation_directory_of_module() and</span>
<a name="line-443"></a><span class="cm"> * g_build_filename() instead.</span>
<a name="line-444"></a><span class="cm"> *</span>
<a name="line-445"></a><span class="cm"> * Returns a newly-allocated string containing the path of the</span>
<a name="line-446"></a><span class="cm"> * subdirectory @subdir in the return value from calling</span>
<a name="line-447"></a><span class="cm"> * g_win32_get_package_installation_directory() with the @package and</span>
<a name="line-448"></a><span class="cm"> * @dll_name parameters. See the documentation for</span>
<a name="line-449"></a><span class="cm"> * g_win32_get_package_installation_directory() for more details. In</span>
<a name="line-450"></a><span class="cm"> * particular, note that it is deprecated to pass anything except NULL</span>
<a name="line-451"></a><span class="cm"> * as @package.</span>
<a name="line-452"></a><span class="cm"> *</span>
<a name="line-453"></a><span class="cm"> * Returns: a string containing the complete path to @subdir inside</span>
<a name="line-454"></a><span class="cm"> * the installation directory of @package. The returned string is in</span>
<a name="line-455"></a><span class="cm"> * the GLib file name encoding, i.e. UTF-8. The return value should be</span>
<a name="line-456"></a><span class="cm"> * freed with g_free() when no longer needed. If something goes wrong,</span>
<a name="line-457"></a><span class="cm"> * %NULL is returned.</span>
<a name="line-458"></a><span class="cm"> *</span>
<a name="line-459"></a><span class="cm"> * Deprecated: 2.18: Pass the HMODULE of a DLL or EXE to</span>
<a name="line-460"></a><span class="cm"> * g_win32_get_package_installation_directory_of_module() instead, and</span>
<a name="line-461"></a><span class="cm"> * then construct a subdirectory pathname with g_build_filename().</span>
<a name="line-462"></a><span class="cm"> **/</span>
<a name="line-463"></a>
<a name="line-464"></a><span class="n">gchar</span> <span class="o">*</span>
<a name="line-465"></a><span class="n">g_win32_get_package_installation_subdirectory</span> <span class="p">(</span><span class="k">const</span> <span class="n">gchar</span> <span class="o">*</span><span class="n">package</span><span class="p">,</span>
<a name="line-466"></a>                                               <span class="k">const</span> <span class="n">gchar</span> <span class="o">*</span><span class="n">dll_name</span><span class="p">,</span>
<a name="line-467"></a>                                               <span class="k">const</span> <span class="n">gchar</span> <span class="o">*</span><span class="n">subdir</span><span class="p">)</span>
<a name="line-468"></a><span class="p">{</span>
<a name="line-469"></a>  <span class="n">gchar</span> <span class="o">*</span><span class="n">prefix</span><span class="p">;</span>
<a name="line-470"></a>  <span class="n">gchar</span> <span class="o">*</span><span class="n">dirname</span><span class="p">;</span>
<a name="line-471"></a>
<a name="line-472"></a><span class="n">G_GNUC_BEGIN_IGNORE_DEPRECATIONS</span>
<a name="line-473"></a>  <span class="n">prefix</span> <span class="o">=</span> <span class="n">g_win32_get_package_installation_directory</span> <span class="p">(</span><span class="n">package</span><span class="p">,</span> <span class="n">dll_name</span><span class="p">);</span>
<a name="line-474"></a><span class="n">G_GNUC_END_IGNORE_DEPRECATIONS</span>
<a name="line-475"></a>
<a name="line-476"></a>  <span class="n">dirname</span> <span class="o">=</span> <span class="n">g_build_filename</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">subdir</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<a name="line-477"></a>  <span class="n">g_free</span> <span class="p">(</span><span class="n">prefix</span><span class="p">);</span>
<a name="line-478"></a>
<a name="line-479"></a>  <span class="k">return</span> <span class="n">dirname</span><span class="p">;</span>
<a name="line-480"></a><span class="p">}</span>
<a name="line-481"></a>
<a name="line-482"></a><span class="cm">/**</span>
<a name="line-483"></a><span class="cm"> * g_win32_check_windows_version:</span>
<a name="line-484"></a><span class="cm"> * @major: major version of Windows</span>
<a name="line-485"></a><span class="cm"> * @minor: minor version of Windows</span>
<a name="line-486"></a><span class="cm"> * @spver: Windows Service Pack Level, 0 if none</span>
<a name="line-487"></a><span class="cm"> * @os_type: Type of Windows OS</span>
<a name="line-488"></a><span class="cm"> *</span>
<a name="line-489"></a><span class="cm"> * Returns whether the version of the Windows operating system the</span>
<a name="line-490"></a><span class="cm"> * code is running on is at least the specified major, minor and</span>
<a name="line-491"></a><span class="cm"> * service pack versions.  See MSDN documentation for the Operating</span>
<a name="line-492"></a><span class="cm"> * System Version.  Software that needs even more detailed version and</span>
<a name="line-493"></a><span class="cm"> * feature information should use the Win32 API VerifyVersionInfo()</span>
<a name="line-494"></a><span class="cm"> * directly.</span>
<a name="line-495"></a><span class="cm"> *</span>
<a name="line-496"></a><span class="cm"> * Successive calls of this function can be used for enabling or</span>
<a name="line-497"></a><span class="cm"> * disabling features at run-time for a range of Windows versions,</span>
<a name="line-498"></a><span class="cm"> * as per the VerifyVersionInfo() API documentation.</span>
<a name="line-499"></a><span class="cm"> *</span>
<a name="line-500"></a><span class="cm"> * Returns: %TRUE if the Windows Version is the same or greater than</span>
<a name="line-501"></a><span class="cm"> *          the specified major, minor and service pack versions, and</span>
<a name="line-502"></a><span class="cm"> *          whether the running Windows is a workstation or server edition</span>
<a name="line-503"></a><span class="cm"> *          of Windows, if specifically specified.</span>
<a name="line-504"></a><span class="cm"> *</span>
<a name="line-505"></a><span class="cm"> * Since: 2.44</span>
<a name="line-506"></a><span class="cm"> **/</span>
<a name="line-507"></a><span class="n">gboolean</span>
<a name="line-508"></a><span class="n">g_win32_check_windows_version</span> <span class="p">(</span><span class="k">const</span> <span class="n">gint</span> <span class="n">major</span><span class="p">,</span>
<a name="line-509"></a>                               <span class="k">const</span> <span class="n">gint</span> <span class="n">minor</span><span class="p">,</span>
<a name="line-510"></a>                               <span class="k">const</span> <span class="n">gint</span> <span class="n">spver</span><span class="p">,</span>
<a name="line-511"></a>                               <span class="k">const</span> <span class="n">GWin32OSType</span> <span class="n">os_type</span><span class="p">)</span>
<a name="line-512"></a><span class="p">{</span>
<a name="line-513"></a>  <span class="n">OSVERSIONINFOEXW</span> <span class="n">osverinfo</span><span class="p">;</span>
<a name="line-514"></a>  <span class="n">gboolean</span> <span class="n">is_ver_checked</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
<a name="line-515"></a>  <span class="n">gboolean</span> <span class="n">is_type_checked</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
<a name="line-516"></a>
<a name="line-517"></a><span class="cp">#if WINAPI_FAMILY != MODERN_API_FAMILY</span>
<a name="line-518"></a>  <span class="cm">/* For non-modern UI Apps, use the LoadLibraryW()/GetProcAddress() thing */</span>
<a name="line-519"></a>  <span class="k">typedef</span> <span class="nf">NTSTATUS</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="n">fRtlGetVersion</span><span class="p">)</span> <span class="p">(</span><span class="n">PRTL_OSVERSIONINFOEXW</span><span class="p">);</span>
<a name="line-520"></a>
<a name="line-521"></a>  <span class="n">fRtlGetVersion</span> <span class="o">*</span><span class="n">RtlGetVersion</span><span class="p">;</span>
<a name="line-522"></a>  <span class="n">HMODULE</span> <span class="n">hmodule</span><span class="p">;</span>
<a name="line-523"></a><span class="cp">#endif</span>
<a name="line-524"></a>  <span class="cm">/* We Only Support Checking for XP or later */</span>
<a name="line-525"></a>  <span class="n">g_return_val_if_fail</span> <span class="p">(</span><span class="n">major</span> <span class="o">&gt;=</span> <span class="mi">5</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">major</span> <span class="o">&lt;=</span><span class="mi">6</span> <span class="o">||</span> <span class="n">major</span> <span class="o">==</span> <span class="mi">10</span><span class="p">),</span> <span class="n">FALSE</span><span class="p">);</span>
<a name="line-526"></a>  <span class="n">g_return_val_if_fail</span> <span class="p">((</span><span class="n">major</span> <span class="o">&gt;=</span> <span class="mi">5</span> <span class="o">&amp;&amp;</span> <span class="n">minor</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="n">major</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">);</span>
<a name="line-527"></a>
<a name="line-528"></a>  <span class="cm">/* Check for Service Pack Version &gt;= 0 */</span>
<a name="line-529"></a>  <span class="n">g_return_val_if_fail</span> <span class="p">(</span><span class="n">spver</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">);</span>
<a name="line-530"></a>
<a name="line-531"></a><span class="cp">#if WINAPI_FAMILY != MODERN_API_FAMILY</span>
<a name="line-532"></a>  <span class="n">hmodule</span> <span class="o">=</span> <span class="n">LoadLibraryW</span> <span class="p">(</span><span class="sa">L</span><span class="s">&quot;ntdll.dll&quot;</span><span class="p">);</span>
<a name="line-533"></a>  <span class="n">g_return_val_if_fail</span> <span class="p">(</span><span class="n">hmodule</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">);</span>
<a name="line-534"></a>
<a name="line-535"></a>  <span class="n">RtlGetVersion</span> <span class="o">=</span> <span class="p">(</span><span class="n">fRtlGetVersion</span> <span class="o">*</span><span class="p">)</span> <span class="n">GetProcAddress</span> <span class="p">(</span><span class="n">hmodule</span><span class="p">,</span> <span class="s">&quot;RtlGetVersion&quot;</span><span class="p">);</span>
<a name="line-536"></a>  <span class="n">g_return_val_if_fail</span> <span class="p">(</span><span class="n">RtlGetVersion</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">);</span>
<a name="line-537"></a><span class="cp">#endif</span>
<a name="line-538"></a>
<a name="line-539"></a>  <span class="n">memset</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">osverinfo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">OSVERSIONINFOEXW</span><span class="p">));</span>
<a name="line-540"></a>  <span class="n">osverinfo</span><span class="p">.</span><span class="n">dwOSVersionInfoSize</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">OSVERSIONINFOEXW</span><span class="p">);</span>
<a name="line-541"></a>  <span class="n">RtlGetVersion</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">osverinfo</span><span class="p">);</span>
<a name="line-542"></a>
<a name="line-543"></a>  <span class="cm">/* check the OS and Service Pack Versions */</span>
<a name="line-544"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">osverinfo</span><span class="p">.</span><span class="n">dwMajorVersion</span> <span class="o">&gt;</span> <span class="n">major</span><span class="p">)</span>
<a name="line-545"></a>    <span class="n">is_ver_checked</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
<a name="line-546"></a>  <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">osverinfo</span><span class="p">.</span><span class="n">dwMajorVersion</span> <span class="o">==</span> <span class="n">major</span><span class="p">)</span>
<a name="line-547"></a>    <span class="p">{</span>
<a name="line-548"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">osverinfo</span><span class="p">.</span><span class="n">dwMinorVersion</span> <span class="o">&gt;</span> <span class="n">minor</span><span class="p">)</span>
<a name="line-549"></a>        <span class="n">is_ver_checked</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
<a name="line-550"></a>      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">osverinfo</span><span class="p">.</span><span class="n">dwMinorVersion</span> <span class="o">==</span> <span class="n">minor</span><span class="p">)</span>
<a name="line-551"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">osverinfo</span><span class="p">.</span><span class="n">wServicePackMajor</span> <span class="o">&gt;=</span> <span class="n">spver</span><span class="p">)</span>
<a name="line-552"></a>          <span class="n">is_ver_checked</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
<a name="line-553"></a>    <span class="p">}</span>
<a name="line-554"></a>
<a name="line-555"></a>  <span class="cm">/* Check OS Type */</span>
<a name="line-556"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">is_ver_checked</span><span class="p">)</span>
<a name="line-557"></a>    <span class="p">{</span>
<a name="line-558"></a>      <span class="k">switch</span> <span class="p">(</span><span class="n">os_type</span><span class="p">)</span>
<a name="line-559"></a>        <span class="p">{</span>
<a name="line-560"></a>          <span class="k">case</span> <span class="nl">G_WIN32_OS_ANY</span><span class="p">:</span>
<a name="line-561"></a>            <span class="n">is_type_checked</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
<a name="line-562"></a>            <span class="k">break</span><span class="p">;</span>
<a name="line-563"></a>          <span class="k">case</span> <span class="nl">G_WIN32_OS_WORKSTATION</span><span class="p">:</span>
<a name="line-564"></a>            <span class="k">if</span> <span class="p">(</span><span class="n">osverinfo</span><span class="p">.</span><span class="n">wProductType</span> <span class="o">==</span> <span class="n">VER_NT_WORKSTATION</span><span class="p">)</span>
<a name="line-565"></a>              <span class="n">is_type_checked</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
<a name="line-566"></a>            <span class="k">break</span><span class="p">;</span>
<a name="line-567"></a>          <span class="k">case</span> <span class="nl">G_WIN32_OS_SERVER</span><span class="p">:</span>
<a name="line-568"></a>            <span class="k">if</span> <span class="p">(</span><span class="n">osverinfo</span><span class="p">.</span><span class="n">wProductType</span> <span class="o">==</span> <span class="n">VER_NT_SERVER</span> <span class="o">||</span>
<a name="line-569"></a>                <span class="n">osverinfo</span><span class="p">.</span><span class="n">wProductType</span> <span class="o">==</span> <span class="n">VER_NT_DOMAIN_CONTROLLER</span><span class="p">)</span>
<a name="line-570"></a>              <span class="n">is_type_checked</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
<a name="line-571"></a>            <span class="k">break</span><span class="p">;</span>
<a name="line-572"></a>          <span class="k">default</span><span class="o">:</span>
<a name="line-573"></a>            <span class="cm">/* shouldn&#39;t get here normally */</span>
<a name="line-574"></a>            <span class="n">g_warning</span> <span class="p">(</span><span class="s">&quot;Invalid os_type specified&quot;</span><span class="p">);</span>
<a name="line-575"></a>            <span class="k">break</span><span class="p">;</span>
<a name="line-576"></a>        <span class="p">}</span>
<a name="line-577"></a>    <span class="p">}</span>
<a name="line-578"></a>
<a name="line-579"></a><span class="cp">#if WINAPI_FAMILY != MODERN_API_FAMILY</span>
<a name="line-580"></a>  <span class="n">FreeLibrary</span> <span class="p">(</span><span class="n">hmodule</span><span class="p">);</span>
<a name="line-581"></a><span class="cp">#endif</span>
<a name="line-582"></a>
<a name="line-583"></a>  <span class="k">return</span> <span class="n">is_ver_checked</span> <span class="o">&amp;&amp;</span> <span class="n">is_type_checked</span><span class="p">;</span>
<a name="line-584"></a><span class="p">}</span>
<a name="line-585"></a>
<a name="line-586"></a><span class="cm">/**</span>
<a name="line-587"></a><span class="cm"> * g_win32_get_windows_version:</span>
<a name="line-588"></a><span class="cm"> *</span>
<a name="line-589"></a><span class="cm"> * This function is deprecated. Use</span>
<a name="line-590"></a><span class="cm"> * g_win32_check_windows_version() instead.</span>
<a name="line-591"></a><span class="cm"> *</span>
<a name="line-592"></a><span class="cm"> * Returns version information for the Windows operating system the</span>
<a name="line-593"></a><span class="cm"> * code is running on. See MSDN documentation for the GetVersion()</span>
<a name="line-594"></a><span class="cm"> * function. To summarize, the most significant bit is one on Win9x,</span>
<a name="line-595"></a><span class="cm"> * and zero on NT-based systems. Since version 2.14, GLib works only</span>
<a name="line-596"></a><span class="cm"> * on NT-based systems, so checking whether your are running on Win9x</span>
<a name="line-597"></a><span class="cm"> * in your own software is moot. The least significant byte is 4 on</span>
<a name="line-598"></a><span class="cm"> * Windows NT 4, and 5 on Windows XP. Software that needs really</span>
<a name="line-599"></a><span class="cm"> * detailed version and feature information should use Win32 API like</span>
<a name="line-600"></a><span class="cm"> * GetVersionEx() and VerifyVersionInfo().</span>
<a name="line-601"></a><span class="cm"> *</span>
<a name="line-602"></a><span class="cm"> * Returns: The version information.</span>
<a name="line-603"></a><span class="cm"> *</span>
<a name="line-604"></a><span class="cm"> * Deprecated: 2.44: Be aware that for Windows 8.1 and Windows Server</span>
<a name="line-605"></a><span class="cm"> * 2012 R2 and later, this will return 62 unless the application is</span>
<a name="line-606"></a><span class="cm"> * manifested for Windows 8.1/Windows Server 2012 R2, for example.</span>
<a name="line-607"></a><span class="cm"> * MSDN stated that GetVersion(), which is used here, is subject to</span>
<a name="line-608"></a><span class="cm"> * further change or removal after Windows 8.1.</span>
<a name="line-609"></a><span class="cm"> **/</span>
<a name="line-610"></a><span class="n">guint</span>
<a name="line-611"></a><span class="n">g_win32_get_windows_version</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<a name="line-612"></a><span class="p">{</span>
<a name="line-613"></a>  <span class="k">static</span> <span class="n">gsize</span> <span class="n">windows_version</span><span class="p">;</span>
<a name="line-614"></a>
<a name="line-615"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">g_once_init_enter</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">windows_version</span><span class="p">))</span>
<a name="line-616"></a>    <span class="n">g_once_init_leave</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">windows_version</span><span class="p">,</span> <span class="n">GetVersion</span> <span class="p">());</span>
<a name="line-617"></a>
<a name="line-618"></a>  <span class="k">return</span> <span class="n">windows_version</span><span class="p">;</span>
<a name="line-619"></a><span class="p">}</span>
<a name="line-620"></a>
<a name="line-621"></a><span class="cm">/*</span>
<a name="line-622"></a><span class="cm"> * Doesn&#39;t use gettext (and gconv), preventing recursive calls when</span>
<a name="line-623"></a><span class="cm"> * g_win32_locale_filename_from_utf8() is called during</span>
<a name="line-624"></a><span class="cm"> * gettext initialization.</span>
<a name="line-625"></a><span class="cm"> */</span>
<a name="line-626"></a><span class="k">static</span> <span class="n">gchar</span> <span class="o">*</span>
<a name="line-627"></a><span class="n">special_wchar_to_locale_encoding</span> <span class="p">(</span><span class="kt">wchar_t</span> <span class="o">*</span><span class="n">wstring</span><span class="p">)</span>
<a name="line-628"></a><span class="p">{</span>
<a name="line-629"></a>  <span class="kt">int</span> <span class="n">sizeof_output</span><span class="p">;</span>
<a name="line-630"></a>  <span class="kt">int</span> <span class="n">wctmb_result</span><span class="p">;</span>
<a name="line-631"></a>  <span class="kt">char</span> <span class="o">*</span><span class="n">result</span><span class="p">;</span>
<a name="line-632"></a>  <span class="n">BOOL</span> <span class="n">not_representable</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
<a name="line-633"></a>
<a name="line-634"></a>  <span class="n">sizeof_output</span> <span class="o">=</span> <span class="n">WideCharToMultiByte</span> <span class="p">(</span><span class="n">CP_ACP</span><span class="p">,</span>
<a name="line-635"></a>                                       <span class="n">WC_NO_BEST_FIT_CHARS</span><span class="p">,</span>
<a name="line-636"></a>                                       <span class="n">wstring</span><span class="p">,</span> <span class="mi">-1</span><span class="p">,</span>
<a name="line-637"></a>                                       <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
<a name="line-638"></a>                                       <span class="nb">NULL</span><span class="p">,</span>
<a name="line-639"></a>                                       <span class="o">&amp;</span><span class="n">not_representable</span><span class="p">);</span>
<a name="line-640"></a>
<a name="line-641"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">not_representable</span> <span class="o">||</span>
<a name="line-642"></a>      <span class="n">sizeof_output</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
<a name="line-643"></a>      <span class="n">sizeof_output</span> <span class="o">&gt;</span> <span class="n">MAX_PATH</span><span class="p">)</span>
<a name="line-644"></a>    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="line-645"></a>
<a name="line-646"></a>  <span class="n">result</span> <span class="o">=</span> <span class="n">g_malloc0</span> <span class="p">(</span><span class="n">sizeof_output</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<a name="line-647"></a>
<a name="line-648"></a>  <span class="n">wctmb_result</span> <span class="o">=</span> <span class="n">WideCharToMultiByte</span> <span class="p">(</span><span class="n">CP_ACP</span><span class="p">,</span>
<a name="line-649"></a>                                      <span class="n">WC_NO_BEST_FIT_CHARS</span><span class="p">,</span>
<a name="line-650"></a>                                      <span class="n">wstring</span><span class="p">,</span> <span class="mi">-1</span><span class="p">,</span>
<a name="line-651"></a>                                      <span class="n">result</span><span class="p">,</span> <span class="n">sizeof_output</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
<a name="line-652"></a>                                      <span class="nb">NULL</span><span class="p">,</span>
<a name="line-653"></a>                                      <span class="o">&amp;</span><span class="n">not_representable</span><span class="p">);</span>
<a name="line-654"></a>
<a name="line-655"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">wctmb_result</span> <span class="o">==</span> <span class="n">sizeof_output</span> <span class="o">&amp;&amp;</span>
<a name="line-656"></a>      <span class="n">not_representable</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span>
<a name="line-657"></a>    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<a name="line-658"></a>
<a name="line-659"></a>  <span class="n">g_free</span> <span class="p">(</span><span class="n">result</span><span class="p">);</span>
<a name="line-660"></a>
<a name="line-661"></a>  <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="line-662"></a><span class="p">}</span>
<a name="line-663"></a>
<a name="line-664"></a><span class="cm">/**</span>
<a name="line-665"></a><span class="cm"> * g_win32_locale_filename_from_utf8:</span>
<a name="line-666"></a><span class="cm"> * @utf8filename: a UTF-8 encoded filename.</span>
<a name="line-667"></a><span class="cm"> *</span>
<a name="line-668"></a><span class="cm"> * Converts a filename from UTF-8 to the system codepage.</span>
<a name="line-669"></a><span class="cm"> *</span>
<a name="line-670"></a><span class="cm"> * On NT-based Windows, on NTFS file systems, file names are in</span>
<a name="line-671"></a><span class="cm"> * Unicode. It is quite possible that Unicode file names contain</span>
<a name="line-672"></a><span class="cm"> * characters not representable in the system codepage. (For instance,</span>
<a name="line-673"></a><span class="cm"> * Greek or Cyrillic characters on Western European or US Windows</span>
<a name="line-674"></a><span class="cm"> * installations, or various less common CJK characters on CJK Windows</span>
<a name="line-675"></a><span class="cm"> * installations.)</span>
<a name="line-676"></a><span class="cm"> *</span>
<a name="line-677"></a><span class="cm"> * In such a case, and if the filename refers to an existing file, and</span>
<a name="line-678"></a><span class="cm"> * the file system stores alternate short (8.3) names for directory</span>
<a name="line-679"></a><span class="cm"> * entries, the short form of the filename is returned. Note that the</span>
<a name="line-680"></a><span class="cm"> * &quot;short&quot; name might in fact be longer than the Unicode name if the</span>
<a name="line-681"></a><span class="cm"> * Unicode name has very short pathname components containing</span>
<a name="line-682"></a><span class="cm"> * non-ASCII characters. If no system codepage name for the file is</span>
<a name="line-683"></a><span class="cm"> * possible, %NULL is returned.</span>
<a name="line-684"></a><span class="cm"> *</span>
<a name="line-685"></a><span class="cm"> * The return value is dynamically allocated and should be freed with</span>
<a name="line-686"></a><span class="cm"> * g_free() when no longer needed.</span>
<a name="line-687"></a><span class="cm"> *</span>
<a name="line-688"></a><span class="cm"> * Returns: The converted filename, or %NULL on conversion</span>
<a name="line-689"></a><span class="cm"> * failure and lack of short names.</span>
<a name="line-690"></a><span class="cm"> *</span>
<a name="line-691"></a><span class="cm"> * Since: 2.8</span>
<a name="line-692"></a><span class="cm"> */</span>
<a name="line-693"></a><span class="n">gchar</span> <span class="o">*</span>
<a name="line-694"></a><span class="n">g_win32_locale_filename_from_utf8</span> <span class="p">(</span><span class="k">const</span> <span class="n">gchar</span> <span class="o">*</span><span class="n">utf8filename</span><span class="p">)</span>
<a name="line-695"></a><span class="p">{</span>
<a name="line-696"></a>  <span class="n">gchar</span> <span class="o">*</span><span class="n">retval</span><span class="p">;</span>
<a name="line-697"></a>  <span class="kt">wchar_t</span> <span class="o">*</span><span class="n">wname</span><span class="p">;</span>
<a name="line-698"></a>
<a name="line-699"></a>  <span class="n">wname</span> <span class="o">=</span> <span class="n">g_utf8_to_utf16</span> <span class="p">(</span><span class="n">utf8filename</span><span class="p">,</span> <span class="mi">-1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<a name="line-700"></a>
<a name="line-701"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">wname</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
<a name="line-702"></a>    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="line-703"></a>
<a name="line-704"></a>  <span class="n">retval</span> <span class="o">=</span> <span class="n">special_wchar_to_locale_encoding</span> <span class="p">(</span><span class="n">wname</span><span class="p">);</span>
<a name="line-705"></a>
<a name="line-706"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
<a name="line-707"></a>    <span class="p">{</span>
<a name="line-708"></a>      <span class="cm">/* Conversion failed, so check if there is a 8.3 version, and use that. */</span>
<a name="line-709"></a>      <span class="kt">wchar_t</span> <span class="n">wshortname</span><span class="p">[</span><span class="n">MAX_PATH</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
<a name="line-710"></a>
<a name="line-711"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">GetShortPathNameW</span> <span class="p">(</span><span class="n">wname</span><span class="p">,</span> <span class="n">wshortname</span><span class="p">,</span> <span class="n">G_N_ELEMENTS</span> <span class="p">(</span><span class="n">wshortname</span><span class="p">)))</span>
<a name="line-712"></a>        <span class="n">retval</span> <span class="o">=</span> <span class="n">special_wchar_to_locale_encoding</span> <span class="p">(</span><span class="n">wshortname</span><span class="p">);</span>
<a name="line-713"></a>    <span class="p">}</span>
<a name="line-714"></a>
<a name="line-715"></a>  <span class="n">g_free</span> <span class="p">(</span><span class="n">wname</span><span class="p">);</span>
<a name="line-716"></a>
<a name="line-717"></a>  <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<a name="line-718"></a><span class="p">}</span>
<a name="line-719"></a>
<a name="line-720"></a><span class="cm">/**</span>
<a name="line-721"></a><span class="cm"> * g_win32_get_command_line:</span>
<a name="line-722"></a><span class="cm"> *</span>
<a name="line-723"></a><span class="cm"> * Gets the command line arguments, on Windows, in the GLib filename</span>
<a name="line-724"></a><span class="cm"> * encoding (ie: UTF-8).</span>
<a name="line-725"></a><span class="cm"> *</span>
<a name="line-726"></a><span class="cm"> * Normally, on Windows, the command line arguments are passed to main()</span>
<a name="line-727"></a><span class="cm"> * in the system codepage encoding.  This prevents passing filenames as</span>
<a name="line-728"></a><span class="cm"> * arguments if the filenames contain characters that fall outside of</span>
<a name="line-729"></a><span class="cm"> * this codepage.  If such filenames are passed, then substitutions</span>
<a name="line-730"></a><span class="cm"> * will occur (such as replacing some characters with &#39;?&#39;).</span>
<a name="line-731"></a><span class="cm"> *</span>
<a name="line-732"></a><span class="cm"> * GLib&#39;s policy of using UTF-8 as a filename encoding on Windows was</span>
<a name="line-733"></a><span class="cm"> * designed to localise the pain of dealing with filenames outside of</span>
<a name="line-734"></a><span class="cm"> * the system codepage to one area: dealing with commandline arguments</span>
<a name="line-735"></a><span class="cm"> * in main().</span>
<a name="line-736"></a><span class="cm"> *</span>
<a name="line-737"></a><span class="cm"> * As such, most GLib programs should ignore the value of argv passed to</span>
<a name="line-738"></a><span class="cm"> * their main() function and call g_win32_get_command_line() instead.</span>
<a name="line-739"></a><span class="cm"> * This will get the &quot;full Unicode&quot; commandline arguments using</span>
<a name="line-740"></a><span class="cm"> * GetCommandLineW() and convert it to the GLib filename encoding (which</span>
<a name="line-741"></a><span class="cm"> * is UTF-8 on Windows).</span>
<a name="line-742"></a><span class="cm"> *</span>
<a name="line-743"></a><span class="cm"> * The strings returned by this function are suitable for use with</span>
<a name="line-744"></a><span class="cm"> * functions such as g_open() and g_file_new_for_commandline_arg() but</span>
<a name="line-745"></a><span class="cm"> * are not suitable for use with g_option_context_parse(), which assumes</span>
<a name="line-746"></a><span class="cm"> * that its input will be in the system codepage.  The return value is</span>
<a name="line-747"></a><span class="cm"> * suitable for use with g_option_context_parse_strv(), however, which</span>
<a name="line-748"></a><span class="cm"> * is a better match anyway because it won&#39;t leak memory.</span>
<a name="line-749"></a><span class="cm"> *</span>
<a name="line-750"></a><span class="cm"> * Unlike argv, the returned value is a normal strv and can (and should)</span>
<a name="line-751"></a><span class="cm"> * be freed with g_strfreev() when no longer needed.</span>
<a name="line-752"></a><span class="cm"> *</span>
<a name="line-753"></a><span class="cm"> * Returns: (transfer full): the commandline arguments in the GLib</span>
<a name="line-754"></a><span class="cm"> *   filename encoding (ie: UTF-8)</span>
<a name="line-755"></a><span class="cm"> *</span>
<a name="line-756"></a><span class="cm"> * Since: 2.40</span>
<a name="line-757"></a><span class="cm"> **/</span>
<a name="line-758"></a><span class="n">gchar</span> <span class="o">**</span>
<a name="line-759"></a><span class="n">g_win32_get_command_line</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<a name="line-760"></a><span class="p">{</span>
<a name="line-761"></a>  <span class="n">gchar</span> <span class="o">**</span><span class="n">result</span><span class="p">;</span>
<a name="line-762"></a>  <span class="n">LPWSTR</span> <span class="o">*</span><span class="n">args</span><span class="p">;</span>
<a name="line-763"></a>  <span class="n">gint</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
<a name="line-764"></a>
<a name="line-765"></a>  <span class="n">args</span> <span class="o">=</span> <span class="n">CommandLineToArgvW</span> <span class="p">(</span><span class="n">GetCommandLineW</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">);</span>
<a name="line-766"></a>
<a name="line-767"></a>  <span class="n">result</span> <span class="o">=</span> <span class="n">g_new</span> <span class="p">(</span><span class="n">gchar</span> <span class="o">*</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<a name="line-768"></a>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a name="line-769"></a>    <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">g_utf16_to_utf8</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">-1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<a name="line-770"></a>  <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="line-771"></a>
<a name="line-772"></a>  <span class="n">LocalFree</span> <span class="p">(</span><span class="n">args</span><span class="p">);</span>
<a name="line-773"></a>  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<a name="line-774"></a><span class="p">}</span>
<a name="line-775"></a>
<a name="line-776"></a><span class="cp">#ifdef G_OS_WIN32</span>
<a name="line-777"></a>
<a name="line-778"></a><span class="cm">/* Binary compatibility versions. Not for newly compiled code. */</span>
<a name="line-779"></a>
<a name="line-780"></a><span class="n">_GLIB_EXTERN</span> <span class="n">gchar</span> <span class="o">*</span><span class="n">g_win32_get_package_installation_directory_utf8</span>    <span class="p">(</span><span class="k">const</span> <span class="n">gchar</span> <span class="o">*</span><span class="n">package</span><span class="p">,</span>
<a name="line-781"></a>                                                                        <span class="k">const</span> <span class="n">gchar</span> <span class="o">*</span><span class="n">dll_name</span><span class="p">);</span>
<a name="line-782"></a>
<a name="line-783"></a><span class="n">_GLIB_EXTERN</span> <span class="n">gchar</span> <span class="o">*</span><span class="n">g_win32_get_package_installation_subdirectory_utf8</span> <span class="p">(</span><span class="k">const</span> <span class="n">gchar</span> <span class="o">*</span><span class="n">package</span><span class="p">,</span>
<a name="line-784"></a>                                                                        <span class="k">const</span> <span class="n">gchar</span> <span class="o">*</span><span class="n">dll_name</span><span class="p">,</span>
<a name="line-785"></a>                                                                        <span class="k">const</span> <span class="n">gchar</span> <span class="o">*</span><span class="n">subdir</span><span class="p">);</span>
<a name="line-786"></a>
<a name="line-787"></a><span class="n">gchar</span> <span class="o">*</span>
<a name="line-788"></a><span class="nf">g_win32_get_package_installation_directory_utf8</span> <span class="p">(</span><span class="k">const</span> <span class="n">gchar</span> <span class="o">*</span><span class="n">package</span><span class="p">,</span>
<a name="line-789"></a>                                                 <span class="k">const</span> <span class="n">gchar</span> <span class="o">*</span><span class="n">dll_name</span><span class="p">)</span>
<a name="line-790"></a><span class="p">{</span>
<a name="line-791"></a><span class="n">G_GNUC_BEGIN_IGNORE_DEPRECATIONS</span>
<a name="line-792"></a>  <span class="k">return</span> <span class="n">g_win32_get_package_installation_directory</span> <span class="p">(</span><span class="n">package</span><span class="p">,</span> <span class="n">dll_name</span><span class="p">);</span>
<a name="line-793"></a><span class="n">G_GNUC_END_IGNORE_DEPRECATIONS</span>
<a name="line-794"></a><span class="p">}</span>
<a name="line-795"></a>
<a name="line-796"></a><span class="n">gchar</span> <span class="o">*</span>
<a name="line-797"></a><span class="nf">g_win32_get_package_installation_subdirectory_utf8</span> <span class="p">(</span><span class="k">const</span> <span class="n">gchar</span> <span class="o">*</span><span class="n">package</span><span class="p">,</span>
<a name="line-798"></a>                                                    <span class="k">const</span> <span class="n">gchar</span> <span class="o">*</span><span class="n">dll_name</span><span class="p">,</span>
<a name="line-799"></a>                                                    <span class="k">const</span> <span class="n">gchar</span> <span class="o">*</span><span class="n">subdir</span><span class="p">)</span>
<a name="line-800"></a><span class="p">{</span>
<a name="line-801"></a><span class="n">G_GNUC_BEGIN_IGNORE_DEPRECATIONS</span>
<a name="line-802"></a>  <span class="k">return</span> <span class="n">g_win32_get_package_installation_subdirectory</span> <span class="p">(</span><span class="n">package</span><span class="p">,</span>
<a name="line-803"></a>                                                        <span class="n">dll_name</span><span class="p">,</span>
<a name="line-804"></a>                                                        <span class="n">subdir</span><span class="p">);</span>
<a name="line-805"></a><span class="n">G_GNUC_END_IGNORE_DEPRECATIONS</span>
<a name="line-806"></a><span class="p">}</span>
<a name="line-807"></a>
<a name="line-808"></a><span class="cp">#endif</span>
<a name="line-809"></a>
<a name="line-810"></a><span class="cp">#ifdef G_OS_WIN32</span>
<a name="line-811"></a>
<a name="line-812"></a><span class="cm">/* This function looks up two environment</span>
<a name="line-813"></a><span class="cm"> * variables, G_WIN32_ALLOC_CONSOLE and G_WIN32_ATTACH_CONSOLE.</span>
<a name="line-814"></a><span class="cm"> * G_WIN32_ALLOC_CONSOLE, if set to 1, makes the process</span>
<a name="line-815"></a><span class="cm"> * call AllocConsole(). This is useful for binaries that</span>
<a name="line-816"></a><span class="cm"> * are compiled to run without automatically-allocated console</span>
<a name="line-817"></a><span class="cm"> * (like most GUI applications).</span>
<a name="line-818"></a><span class="cm"> * G_WIN32_ATTACH_CONSOLE, if set to a comma-separated list</span>
<a name="line-819"></a><span class="cm"> * of one or more strings &quot;stdout&quot;, &quot;stdin&quot; and &quot;stderr&quot;,</span>
<a name="line-820"></a><span class="cm"> * makes the process reopen the corresponding standard streams</span>
<a name="line-821"></a><span class="cm"> * to ensure that they are attached to the files that</span>
<a name="line-822"></a><span class="cm"> * GetStdHandle() returns, which, hopefully, would be</span>
<a name="line-823"></a><span class="cm"> * either a file handle or a console handle.</span>
<a name="line-824"></a><span class="cm"> *</span>
<a name="line-825"></a><span class="cm"> * This function is called automatically when glib DLL is</span>
<a name="line-826"></a><span class="cm"> * attached to a process, from DllMain().</span>
<a name="line-827"></a><span class="cm"> */</span>
<a name="line-828"></a><span class="kt">void</span>
<a name="line-829"></a><span class="nf">g_console_win32_init</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<a name="line-830"></a><span class="p">{</span>
<a name="line-831"></a>  <span class="k">struct</span>
<a name="line-832"></a>    <span class="p">{</span>
<a name="line-833"></a>      <span class="n">gboolean</span>     <span class="n">redirect</span><span class="p">;</span>
<a name="line-834"></a>      <span class="kt">FILE</span>        <span class="o">*</span><span class="n">stream</span><span class="p">;</span>
<a name="line-835"></a>      <span class="k">const</span> <span class="n">gchar</span> <span class="o">*</span><span class="n">stream_name</span><span class="p">;</span>
<a name="line-836"></a>      <span class="n">DWORD</span>        <span class="n">std_handle_type</span><span class="p">;</span>
<a name="line-837"></a>      <span class="kt">int</span>          <span class="n">flags</span><span class="p">;</span>
<a name="line-838"></a>      <span class="k">const</span> <span class="n">gchar</span> <span class="o">*</span><span class="n">mode</span><span class="p">;</span>
<a name="line-839"></a>    <span class="p">}</span>
<a name="line-840"></a>  <span class="n">streams</span><span class="p">[]</span> <span class="o">=</span>
<a name="line-841"></a>    <span class="p">{</span>
<a name="line-842"></a>      <span class="p">{</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">stdin</span><span class="p">,</span> <span class="s">&quot;stdin&quot;</span><span class="p">,</span> <span class="n">STD_INPUT_HANDLE</span><span class="p">,</span> <span class="n">_O_RDONLY</span><span class="p">,</span> <span class="s">&quot;rb&quot;</span> <span class="p">},</span>
<a name="line-843"></a>      <span class="p">{</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;stdout&quot;</span><span class="p">,</span> <span class="n">STD_OUTPUT_HANDLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span> <span class="p">},</span>
<a name="line-844"></a>      <span class="p">{</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;stderr&quot;</span><span class="p">,</span> <span class="n">STD_ERROR_HANDLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span> <span class="p">},</span>
<a name="line-845"></a>    <span class="p">};</span>
<a name="line-846"></a>
<a name="line-847"></a>  <span class="k">const</span> <span class="n">gchar</span>  <span class="o">*</span><span class="n">attach_envvar</span><span class="p">;</span>
<a name="line-848"></a>  <span class="n">guint</span>         <span class="n">i</span><span class="p">;</span>
<a name="line-849"></a>  <span class="n">gchar</span>       <span class="o">**</span><span class="n">attach_strs</span><span class="p">;</span>
<a name="line-850"></a>
<a name="line-851"></a>  <span class="cm">/* Note: it&#39;s not a very good practice to use DllMain()</span>
<a name="line-852"></a><span class="cm">   * to call any functions not in Kernel32.dll.</span>
<a name="line-853"></a><span class="cm">   * The following only works if there are no weird</span>
<a name="line-854"></a><span class="cm">   * circular DLL dependencies that could cause glib DllMain()</span>
<a name="line-855"></a><span class="cm">   * to be called before CRT DllMain().</span>
<a name="line-856"></a><span class="cm">   */</span>
<a name="line-857"></a>
<a name="line-858"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">g_strcmp0</span> <span class="p">(</span><span class="n">g_getenv</span> <span class="p">(</span><span class="s">&quot;G_WIN32_ALLOC_CONSOLE&quot;</span><span class="p">),</span> <span class="s">&quot;1&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="line-859"></a>    <span class="n">AllocConsole</span> <span class="p">();</span> <span class="cm">/* no error handling, fails if console already exists */</span>
<a name="line-860"></a>
<a name="line-861"></a>  <span class="n">attach_envvar</span> <span class="o">=</span> <span class="n">g_getenv</span> <span class="p">(</span><span class="s">&quot;G_WIN32_ATTACH_CONSOLE&quot;</span><span class="p">);</span>
<a name="line-862"></a>
<a name="line-863"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">attach_envvar</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
<a name="line-864"></a>    <span class="k">return</span><span class="p">;</span>
<a name="line-865"></a>
<a name="line-866"></a>  <span class="cm">/* Re-use parent console, if we don&#39;t have our own.</span>
<a name="line-867"></a><span class="cm">   * If we do, it will fail, so just ignore the error.</span>
<a name="line-868"></a><span class="cm">   */</span>
<a name="line-869"></a>  <span class="n">AttachConsole</span> <span class="p">(</span><span class="n">ATTACH_PARENT_PROCESS</span><span class="p">);</span>
<a name="line-870"></a>
<a name="line-871"></a>  <span class="n">attach_strs</span> <span class="o">=</span> <span class="n">g_strsplit</span> <span class="p">(</span><span class="n">attach_envvar</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">,</span> <span class="mi">-1</span><span class="p">);</span>
<a name="line-872"></a>
<a name="line-873"></a>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">attach_strs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a name="line-874"></a>    <span class="p">{</span>
<a name="line-875"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">g_strcmp0</span> <span class="p">(</span><span class="n">attach_strs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s">&quot;stdout&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="line-876"></a>        <span class="n">streams</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">redirect</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
<a name="line-877"></a>      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">g_strcmp0</span> <span class="p">(</span><span class="n">attach_strs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s">&quot;stderr&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="line-878"></a>        <span class="n">streams</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">redirect</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
<a name="line-879"></a>      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">g_strcmp0</span> <span class="p">(</span><span class="n">attach_strs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s">&quot;stdin&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="line-880"></a>        <span class="n">streams</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">redirect</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
<a name="line-881"></a>      <span class="k">else</span>
<a name="line-882"></a>        <span class="n">g_warning</span> <span class="p">(</span><span class="s">&quot;Unrecognized stream name %s&quot;</span><span class="p">,</span> <span class="n">attach_strs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<a name="line-883"></a>    <span class="p">}</span>
<a name="line-884"></a>
<a name="line-885"></a>  <span class="n">g_strfreev</span> <span class="p">(</span><span class="n">attach_strs</span><span class="p">);</span>
<a name="line-886"></a>
<a name="line-887"></a>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">G_N_ELEMENTS</span> <span class="p">(</span><span class="n">streams</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a name="line-888"></a>    <span class="p">{</span>
<a name="line-889"></a>      <span class="kt">int</span>          <span class="n">old_fd</span><span class="p">;</span>
<a name="line-890"></a>      <span class="kt">int</span>          <span class="n">backup_fd</span><span class="p">;</span>
<a name="line-891"></a>      <span class="kt">int</span>          <span class="n">new_fd</span><span class="p">;</span>
<a name="line-892"></a>      <span class="kt">int</span>          <span class="n">preferred_fd</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
<a name="line-893"></a>      <span class="n">HANDLE</span>       <span class="n">std_handle</span><span class="p">;</span>
<a name="line-894"></a>      <span class="n">errno_t</span>      <span class="n">errsv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="line-895"></a>
<a name="line-896"></a>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">streams</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">redirect</span><span class="p">)</span>
<a name="line-897"></a>        <span class="k">continue</span><span class="p">;</span>
<a name="line-898"></a>
<a name="line-899"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">ferror</span> <span class="p">(</span><span class="n">streams</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">stream</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
<a name="line-900"></a>        <span class="p">{</span>
<a name="line-901"></a>          <span class="n">g_warning</span> <span class="p">(</span><span class="s">&quot;Stream %s is in error state&quot;</span><span class="p">,</span> <span class="n">streams</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">stream_name</span><span class="p">);</span>
<a name="line-902"></a>          <span class="k">continue</span><span class="p">;</span>
<a name="line-903"></a>        <span class="p">}</span>
<a name="line-904"></a>
<a name="line-905"></a>      <span class="n">std_handle</span> <span class="o">=</span> <span class="n">GetStdHandle</span> <span class="p">(</span><span class="n">streams</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">std_handle_type</span><span class="p">);</span>
<a name="line-906"></a>
<a name="line-907"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">std_handle</span> <span class="o">==</span> <span class="n">INVALID_HANDLE_VALUE</span><span class="p">)</span>
<a name="line-908"></a>        <span class="p">{</span>
<a name="line-909"></a>          <span class="n">DWORD</span> <span class="n">gle</span> <span class="o">=</span> <span class="n">GetLastError</span> <span class="p">();</span>
<a name="line-910"></a>          <span class="n">g_warning</span> <span class="p">(</span><span class="s">&quot;Standard handle for %s can&#39;t be obtained: %lu&quot;</span><span class="p">,</span>
<a name="line-911"></a>                     <span class="n">streams</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">stream_name</span><span class="p">,</span> <span class="n">gle</span><span class="p">);</span>
<a name="line-912"></a>          <span class="k">continue</span><span class="p">;</span>
<a name="line-913"></a>        <span class="p">}</span>
<a name="line-914"></a>
<a name="line-915"></a>      <span class="n">old_fd</span> <span class="o">=</span> <span class="n">fileno</span> <span class="p">(</span><span class="n">streams</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">stream</span><span class="p">);</span>
<a name="line-916"></a>
<a name="line-917"></a>      <span class="cm">/* We need the stream object to be associated with</span>
<a name="line-918"></a><span class="cm">       * any valid integer fd for the code to work.</span>
<a name="line-919"></a><span class="cm">       * If it isn&#39;t, reopen it with NUL (/dev/null) to</span>
<a name="line-920"></a><span class="cm">       * ensure that it is.</span>
<a name="line-921"></a><span class="cm">       */</span>
<a name="line-922"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">old_fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="line-923"></a>        <span class="p">{</span>
<a name="line-924"></a>          <span class="k">if</span> <span class="p">(</span><span class="n">freopen</span> <span class="p">(</span><span class="s">&quot;NUL&quot;</span><span class="p">,</span> <span class="n">streams</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mode</span><span class="p">,</span> <span class="n">streams</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">stream</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
<a name="line-925"></a>            <span class="p">{</span>
<a name="line-926"></a>              <span class="n">errsv</span> <span class="o">=</span> <span class="n">errno</span><span class="p">;</span>
<a name="line-927"></a>              <span class="n">g_warning</span> <span class="p">(</span><span class="s">&quot;Failed to redirect %s: %d - %s&quot;</span><span class="p">,</span>
<a name="line-928"></a>                         <span class="n">streams</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">stream_name</span><span class="p">,</span>
<a name="line-929"></a>                         <span class="n">errsv</span><span class="p">,</span>
<a name="line-930"></a>                         <span class="n">strerror</span> <span class="p">(</span><span class="n">errsv</span><span class="p">));</span>
<a name="line-931"></a>              <span class="k">continue</span><span class="p">;</span>
<a name="line-932"></a>            <span class="p">}</span>
<a name="line-933"></a>
<a name="line-934"></a>          <span class="n">old_fd</span> <span class="o">=</span> <span class="n">fileno</span> <span class="p">(</span><span class="n">streams</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">stream</span><span class="p">);</span>
<a name="line-935"></a>
<a name="line-936"></a>          <span class="k">if</span> <span class="p">(</span><span class="n">old_fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="line-937"></a>            <span class="p">{</span>
<a name="line-938"></a>              <span class="n">g_warning</span> <span class="p">(</span><span class="s">&quot;Stream %s does not have a valid fd&quot;</span><span class="p">,</span>
<a name="line-939"></a>                         <span class="n">streams</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">stream_name</span><span class="p">);</span>
<a name="line-940"></a>              <span class="k">continue</span><span class="p">;</span>
<a name="line-941"></a>            <span class="p">}</span>
<a name="line-942"></a>        <span class="p">}</span>
<a name="line-943"></a>
<a name="line-944"></a>      <span class="n">new_fd</span> <span class="o">=</span> <span class="n">_open_osfhandle</span> <span class="p">((</span><span class="kt">intptr_t</span><span class="p">)</span> <span class="n">std_handle</span><span class="p">,</span> <span class="n">streams</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span><span class="p">);</span>
<a name="line-945"></a>
<a name="line-946"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">new_fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="line-947"></a>        <span class="p">{</span>
<a name="line-948"></a>          <span class="n">g_warning</span> <span class="p">(</span><span class="s">&quot;Failed to create new fd for stream %s&quot;</span><span class="p">,</span>
<a name="line-949"></a>                     <span class="n">streams</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">stream_name</span><span class="p">);</span>
<a name="line-950"></a>          <span class="k">continue</span><span class="p">;</span>
<a name="line-951"></a>        <span class="p">}</span>
<a name="line-952"></a>
<a name="line-953"></a>      <span class="n">backup_fd</span> <span class="o">=</span> <span class="n">dup</span> <span class="p">(</span><span class="n">old_fd</span><span class="p">);</span>
<a name="line-954"></a>
<a name="line-955"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">backup_fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="line-956"></a>        <span class="n">g_warning</span> <span class="p">(</span><span class="s">&quot;Failed to backup old fd %d for stream %s&quot;</span><span class="p">,</span>
<a name="line-957"></a>                   <span class="n">old_fd</span><span class="p">,</span> <span class="n">streams</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">stream_name</span><span class="p">);</span>
<a name="line-958"></a>
<a name="line-959"></a>      <span class="n">errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="line-960"></a>
<a name="line-961"></a>      <span class="cm">/* Force old_fd to be associated with the same file</span>
<a name="line-962"></a><span class="cm">       * as new_fd, i.e with the standard handle we need</span>
<a name="line-963"></a><span class="cm">       * (or, rather, with the same kernel object; handle</span>
<a name="line-964"></a><span class="cm">       * value will be different, but the kernel object</span>
<a name="line-965"></a><span class="cm">       * won&#39;t be).</span>
<a name="line-966"></a><span class="cm">       */</span>
<a name="line-967"></a>      <span class="cm">/* NOTE: MSDN claims that _dup2() returns 0 on success and -1 on error,</span>
<a name="line-968"></a><span class="cm">       * POSIX claims that dup2() reurns new FD on success and -1 on error.</span>
<a name="line-969"></a><span class="cm">       * The &quot;&lt; 0&quot; check satisfies the error condition for either implementation.</span>
<a name="line-970"></a><span class="cm">       */</span>
<a name="line-971"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">_dup2</span> <span class="p">(</span><span class="n">new_fd</span><span class="p">,</span> <span class="n">old_fd</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="line-972"></a>        <span class="p">{</span>
<a name="line-973"></a>          <span class="n">errsv</span> <span class="o">=</span> <span class="n">errno</span><span class="p">;</span>
<a name="line-974"></a>          <span class="n">g_warning</span> <span class="p">(</span><span class="s">&quot;Failed to substitute fd %d for stream %s: %d : %s&quot;</span><span class="p">,</span>
<a name="line-975"></a>                     <span class="n">old_fd</span><span class="p">,</span> <span class="n">streams</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">stream_name</span><span class="p">,</span> <span class="n">errsv</span><span class="p">,</span> <span class="n">strerror</span> <span class="p">(</span><span class="n">errsv</span><span class="p">));</span>
<a name="line-976"></a>
<a name="line-977"></a>          <span class="n">_close</span> <span class="p">(</span><span class="n">new_fd</span><span class="p">);</span>
<a name="line-978"></a>
<a name="line-979"></a>          <span class="k">if</span> <span class="p">(</span><span class="n">backup_fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="line-980"></a>            <span class="k">continue</span><span class="p">;</span>
<a name="line-981"></a>
<a name="line-982"></a>          <span class="n">errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="line-983"></a>
<a name="line-984"></a>          <span class="cm">/* Try to restore old_fd back to its previous</span>
<a name="line-985"></a><span class="cm">           * handle, in case the _dup2() call above succeeded partially.</span>
<a name="line-986"></a><span class="cm">           */</span>
<a name="line-987"></a>          <span class="k">if</span> <span class="p">(</span><span class="n">_dup2</span> <span class="p">(</span><span class="n">backup_fd</span><span class="p">,</span> <span class="n">old_fd</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="line-988"></a>            <span class="p">{</span>
<a name="line-989"></a>              <span class="n">errsv</span> <span class="o">=</span> <span class="n">errno</span><span class="p">;</span>
<a name="line-990"></a>              <span class="n">g_warning</span> <span class="p">(</span><span class="s">&quot;Failed to restore fd %d for stream %s: %d : %s&quot;</span><span class="p">,</span>
<a name="line-991"></a>                         <span class="n">old_fd</span><span class="p">,</span> <span class="n">streams</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">stream_name</span><span class="p">,</span> <span class="n">errsv</span><span class="p">,</span> <span class="n">strerror</span> <span class="p">(</span><span class="n">errsv</span><span class="p">));</span>
<a name="line-992"></a>            <span class="p">}</span>
<a name="line-993"></a>
<a name="line-994"></a>          <span class="n">_close</span> <span class="p">(</span><span class="n">backup_fd</span><span class="p">);</span>
<a name="line-995"></a>
<a name="line-996"></a>          <span class="k">continue</span><span class="p">;</span>
<a name="line-997"></a>        <span class="p">}</span>
<a name="line-998"></a>
<a name="line-999"></a>      <span class="cm">/* Success, drop the backup */</span>
<a name="line-1000"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">backup_fd</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
<a name="line-1001"></a>        <span class="n">_close</span> <span class="p">(</span><span class="n">backup_fd</span><span class="p">);</span>
<a name="line-1002"></a>
<a name="line-1003"></a>      <span class="cm">/* Sadly, there&#39;s no way to check that preferred_fd</span>
<a name="line-1004"></a><span class="cm">       * is currently valid, so we can&#39;t back it up.</span>
<a name="line-1005"></a><span class="cm">       * Doing operations on invalid FDs invokes invalid</span>
<a name="line-1006"></a><span class="cm">       * parameter handler, which is bad for us.</span>
<a name="line-1007"></a><span class="cm">       */</span>
<a name="line-1008"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">old_fd</span> <span class="o">!=</span> <span class="n">preferred_fd</span><span class="p">)</span>
<a name="line-1009"></a>        <span class="cm">/* This extra code will also try to ensure that</span>
<a name="line-1010"></a><span class="cm">         * the expected file descriptors 0, 1 and 2 are</span>
<a name="line-1011"></a><span class="cm">         * associated with the appropriate standard</span>
<a name="line-1012"></a><span class="cm">         * handles.</span>
<a name="line-1013"></a><span class="cm">         */</span>
<a name="line-1014"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">_dup2</span> <span class="p">(</span><span class="n">new_fd</span><span class="p">,</span> <span class="n">preferred_fd</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="line-1015"></a>          <span class="n">g_warning</span> <span class="p">(</span><span class="s">&quot;Failed to dup fd %d into fd %d&quot;</span><span class="p">,</span> <span class="n">new_fd</span><span class="p">,</span> <span class="n">preferred_fd</span><span class="p">);</span>
<a name="line-1016"></a>
<a name="line-1017"></a>      <span class="n">_close</span> <span class="p">(</span><span class="n">new_fd</span><span class="p">);</span>
<a name="line-1018"></a>    <span class="p">}</span>
<a name="line-1019"></a><span class="p">}</span>
<a name="line-1020"></a>
<a name="line-1021"></a><span class="cm">/* This is a handle to the Vectored Exception Handler that</span>
<a name="line-1022"></a><span class="cm"> * we install on library initialization. If installed correctly,</span>
<a name="line-1023"></a><span class="cm"> * it will be non-NULL. Only used to later de-install the handler</span>
<a name="line-1024"></a><span class="cm"> * on library de-initialization.</span>
<a name="line-1025"></a><span class="cm"> */</span>
<a name="line-1026"></a><span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="n">WinVEH_handle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="line-1027"></a>
<a name="line-1028"></a><span class="cp">#include</span> <span class="cpf">&quot;gwin32-private.c&quot;</span><span class="cp"></span>
<a name="line-1029"></a>
<a name="line-1030"></a><span class="cm">/* Handles exceptions (useful for debugging).</span>
<a name="line-1031"></a><span class="cm"> * Issues a DebugBreak() call if the process is being debugged (not really</span>
<a name="line-1032"></a><span class="cm"> * useful - if the process is being debugged, this handler won&#39;t be invoked</span>
<a name="line-1033"></a><span class="cm"> * anyway). If it is not, runs a debugger from G_DEBUGGER env var,</span>
<a name="line-1034"></a><span class="cm"> * substituting first %p in it for PID, and the first %e for the event handle -</span>
<a name="line-1035"></a><span class="cm"> * that event should be set once the debugger attaches itself (otherwise the</span>
<a name="line-1036"></a><span class="cm"> * only way out of WaitForSingleObject() is to time out after 1 minute).</span>
<a name="line-1037"></a><span class="cm"> * For example, G_DEBUGGER can be set to the following command:</span>
<a name="line-1038"></a><span class="cm"> * ```</span>
<a name="line-1039"></a><span class="cm"> * gdb.exe -ex &quot;attach %p&quot; -ex &quot;signal-event %e&quot; -ex &quot;bt&quot; -ex &quot;c&quot;</span>
<a name="line-1040"></a><span class="cm"> * ```</span>
<a name="line-1041"></a><span class="cm"> * This will make GDB attach to the process, signal the event (GDB must be</span>
<a name="line-1042"></a><span class="cm"> * recent enough for the signal-event command to be available),</span>
<a name="line-1043"></a><span class="cm"> * show the backtrace and resume execution, which should make it catch</span>
<a name="line-1044"></a><span class="cm"> * the exception when Windows re-raises it again.</span>
<a name="line-1045"></a><span class="cm"> * The command line can&#39;t be longer than MAX_PATH (260 characters).</span>
<a name="line-1046"></a><span class="cm"> *</span>
<a name="line-1047"></a><span class="cm"> * This function will only stop (and run a debugger) on the following exceptions:</span>
<a name="line-1048"></a><span class="cm"> * * EXCEPTION_ACCESS_VIOLATION</span>
<a name="line-1049"></a><span class="cm"> * * EXCEPTION_STACK_OVERFLOW</span>
<a name="line-1050"></a><span class="cm"> * * EXCEPTION_ILLEGAL_INSTRUCTION</span>
<a name="line-1051"></a><span class="cm"> * To make it stop at other exceptions one should set the G_VEH_CATCH</span>
<a name="line-1052"></a><span class="cm"> * environment variable to a list of comma-separated hexadecimal numbers,</span>
<a name="line-1053"></a><span class="cm"> * where each number is the code of an exception that should be caught.</span>
<a name="line-1054"></a><span class="cm"> * This is done to prevent GLib from breaking when Windows uses</span>
<a name="line-1055"></a><span class="cm"> * exceptions to shuttle information (SetThreadName(), OutputDebugString())</span>
<a name="line-1056"></a><span class="cm"> * or for control flow.</span>
<a name="line-1057"></a><span class="cm"> *</span>
<a name="line-1058"></a><span class="cm"> * This function deliberately avoids calling any GLib code.</span>
<a name="line-1059"></a><span class="cm"> */</span>
<a name="line-1060"></a><span class="k">static</span> <span class="n">LONG</span> <span class="kr">__stdcall</span>
<a name="line-1061"></a><span class="n">g_win32_veh_handler</span> <span class="p">(</span><span class="n">PEXCEPTION_POINTERS</span> <span class="n">ExceptionInfo</span><span class="p">)</span>
<a name="line-1062"></a><span class="p">{</span>
<a name="line-1063"></a>  <span class="n">EXCEPTION_RECORD</span>    <span class="o">*</span><span class="n">er</span><span class="p">;</span>
<a name="line-1064"></a>  <span class="kt">char</span>                 <span class="n">debugger</span><span class="p">[</span><span class="n">MAX_PATH</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
<a name="line-1065"></a>  <span class="k">const</span> <span class="kt">char</span>          <span class="o">*</span><span class="n">debugger_env</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="line-1066"></a>  <span class="k">const</span> <span class="kt">char</span>          <span class="o">*</span><span class="n">catch_list</span><span class="p">;</span>
<a name="line-1067"></a>  <span class="n">gboolean</span>             <span class="n">catch</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
<a name="line-1068"></a>  <span class="n">STARTUPINFO</span>          <span class="n">si</span><span class="p">;</span>
<a name="line-1069"></a>  <span class="n">PROCESS_INFORMATION</span>  <span class="n">pi</span><span class="p">;</span>
<a name="line-1070"></a>  <span class="n">HANDLE</span>               <span class="n">event</span><span class="p">;</span>
<a name="line-1071"></a>  <span class="n">SECURITY_ATTRIBUTES</span>  <span class="n">sa</span><span class="p">;</span>
<a name="line-1072"></a>
<a name="line-1073"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">ExceptionInfo</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
<a name="line-1074"></a>      <span class="n">ExceptionInfo</span><span class="o">-&gt;</span><span class="n">ExceptionRecord</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
<a name="line-1075"></a>      <span class="n">IsDebuggerPresent</span> <span class="p">())</span>
<a name="line-1076"></a>    <span class="k">return</span> <span class="n">EXCEPTION_CONTINUE_SEARCH</span><span class="p">;</span>
<a name="line-1077"></a>
<a name="line-1078"></a>  <span class="n">er</span> <span class="o">=</span> <span class="n">ExceptionInfo</span><span class="o">-&gt;</span><span class="n">ExceptionRecord</span><span class="p">;</span>
<a name="line-1079"></a>
<a name="line-1080"></a>  <span class="k">switch</span> <span class="p">(</span><span class="n">er</span><span class="o">-&gt;</span><span class="n">ExceptionCode</span><span class="p">)</span>
<a name="line-1081"></a>    <span class="p">{</span>
<a name="line-1082"></a>    <span class="k">case</span> <span class="nl">EXCEPTION_ACCESS_VIOLATION</span><span class="p">:</span>
<a name="line-1083"></a>    <span class="k">case</span> <span class="nl">EXCEPTION_STACK_OVERFLOW</span><span class="p">:</span>
<a name="line-1084"></a>    <span class="k">case</span> <span class="nl">EXCEPTION_ILLEGAL_INSTRUCTION</span><span class="p">:</span>
<a name="line-1085"></a>      <span class="k">break</span><span class="p">;</span>
<a name="line-1086"></a>    <span class="k">default</span><span class="o">:</span>
<a name="line-1087"></a>      <span class="n">catch_list</span> <span class="o">=</span> <span class="n">g_getenv</span> <span class="p">(</span><span class="s">&quot;G_VEH_CATCH&quot;</span><span class="p">);</span>
<a name="line-1088"></a>
<a name="line-1089"></a>      <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">catch</span> <span class="o">&amp;&amp;</span>
<a name="line-1090"></a>             <span class="n">catch_list</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
<a name="line-1091"></a>             <span class="n">catch_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
<a name="line-1092"></a>        <span class="p">{</span>
<a name="line-1093"></a>          <span class="kt">unsigned</span> <span class="kt">long</span>  <span class="n">catch_code</span><span class="p">;</span>
<a name="line-1094"></a>          <span class="kt">char</span>          <span class="o">*</span><span class="n">end</span><span class="p">;</span>
<a name="line-1095"></a>          <span class="n">errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="line-1096"></a>          <span class="n">catch_code</span> <span class="o">=</span> <span class="n">strtoul</span> <span class="p">(</span><span class="n">catch_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">end</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
<a name="line-1097"></a>          <span class="k">if</span> <span class="p">(</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">NO_ERROR</span><span class="p">)</span>
<a name="line-1098"></a>            <span class="k">break</span><span class="p">;</span>
<a name="line-1099"></a>          <span class="n">catch_list</span> <span class="o">=</span> <span class="n">end</span><span class="p">;</span>
<a name="line-1100"></a>          <span class="k">if</span> <span class="p">(</span><span class="n">catch_list</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">catch_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;,&#39;</span><span class="p">)</span>
<a name="line-1101"></a>            <span class="n">catch_list</span><span class="o">++</span><span class="p">;</span>
<a name="line-1102"></a>          <span class="k">if</span> <span class="p">(</span><span class="n">catch_code</span> <span class="o">==</span> <span class="n">er</span><span class="o">-&gt;</span><span class="n">ExceptionCode</span><span class="p">)</span>
<a name="line-1103"></a>            <span class="n">catch</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
<a name="line-1104"></a>        <span class="p">}</span>
<a name="line-1105"></a>
<a name="line-1106"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">catch</span><span class="p">)</span>
<a name="line-1107"></a>        <span class="k">break</span><span class="p">;</span>
<a name="line-1108"></a>
<a name="line-1109"></a>      <span class="k">return</span> <span class="n">EXCEPTION_CONTINUE_SEARCH</span><span class="p">;</span>
<a name="line-1110"></a>    <span class="p">}</span>
<a name="line-1111"></a>
<a name="line-1112"></a>  <span class="n">fprintf_s</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
<a name="line-1113"></a>             <span class="s">&quot;Exception code=0x%lx flags=0x%lx at 0x%p&quot;</span><span class="p">,</span>
<a name="line-1114"></a>             <span class="n">er</span><span class="o">-&gt;</span><span class="n">ExceptionCode</span><span class="p">,</span>
<a name="line-1115"></a>             <span class="n">er</span><span class="o">-&gt;</span><span class="n">ExceptionFlags</span><span class="p">,</span>
<a name="line-1116"></a>             <span class="n">er</span><span class="o">-&gt;</span><span class="n">ExceptionAddress</span><span class="p">);</span>
<a name="line-1117"></a>
<a name="line-1118"></a>  <span class="k">switch</span> <span class="p">(</span><span class="n">er</span><span class="o">-&gt;</span><span class="n">ExceptionCode</span><span class="p">)</span>
<a name="line-1119"></a>    <span class="p">{</span>
<a name="line-1120"></a>    <span class="k">case</span> <span class="nl">EXCEPTION_ACCESS_VIOLATION</span><span class="p">:</span>
<a name="line-1121"></a>      <span class="n">fprintf_s</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
<a name="line-1122"></a>                 <span class="s">&quot;. Access violation - attempting to %s at address 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<a name="line-1123"></a>                 <span class="n">er</span><span class="o">-&gt;</span><span class="n">ExceptionInformation</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="s">&quot;read data&quot;</span> <span class="o">:</span>
<a name="line-1124"></a>                 <span class="n">er</span><span class="o">-&gt;</span><span class="n">ExceptionInformation</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="s">&quot;write data&quot;</span> <span class="o">:</span>
<a name="line-1125"></a>                 <span class="n">er</span><span class="o">-&gt;</span><span class="n">ExceptionInformation</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">8</span> <span class="o">?</span> <span class="s">&quot;execute data&quot;</span> <span class="o">:</span>
<a name="line-1126"></a>                 <span class="s">&quot;do something bad&quot;</span><span class="p">,</span>
<a name="line-1127"></a>                 <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">er</span><span class="o">-&gt;</span><span class="n">ExceptionInformation</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<a name="line-1128"></a>      <span class="k">break</span><span class="p">;</span>
<a name="line-1129"></a>    <span class="k">case</span> <span class="nl">EXCEPTION_IN_PAGE_ERROR</span><span class="p">:</span>
<a name="line-1130"></a>      <span class="n">fprintf_s</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
<a name="line-1131"></a>                 <span class="s">&quot;. Page access violation - attempting to %s at address 0x%p with status %Ix</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<a name="line-1132"></a>                 <span class="n">er</span><span class="o">-&gt;</span><span class="n">ExceptionInformation</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="s">&quot;read from an inaccessible page&quot;</span> <span class="o">:</span>
<a name="line-1133"></a>                 <span class="n">er</span><span class="o">-&gt;</span><span class="n">ExceptionInformation</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="s">&quot;write to an inaccessible page&quot;</span> <span class="o">:</span>
<a name="line-1134"></a>                 <span class="n">er</span><span class="o">-&gt;</span><span class="n">ExceptionInformation</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">8</span> <span class="o">?</span> <span class="s">&quot;execute data in page&quot;</span> <span class="o">:</span>
<a name="line-1135"></a>                 <span class="s">&quot;do something bad with a page&quot;</span><span class="p">,</span>
<a name="line-1136"></a>                 <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">er</span><span class="o">-&gt;</span><span class="n">ExceptionInformation</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
<a name="line-1137"></a>                 <span class="n">er</span><span class="o">-&gt;</span><span class="n">ExceptionInformation</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
<a name="line-1138"></a>      <span class="k">break</span><span class="p">;</span>
<a name="line-1139"></a>    <span class="k">default</span><span class="o">:</span>
<a name="line-1140"></a>      <span class="n">fprintf_s</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a name="line-1141"></a>      <span class="k">break</span><span class="p">;</span>
<a name="line-1142"></a>    <span class="p">}</span>
<a name="line-1143"></a>
<a name="line-1144"></a>  <span class="n">fflush</span> <span class="p">(</span><span class="n">stderr</span><span class="p">);</span>
<a name="line-1145"></a>
<a name="line-1146"></a>  <span class="n">debugger_env</span> <span class="o">=</span> <span class="n">g_getenv</span> <span class="p">(</span><span class="s">&quot;G_DEBUGGER&quot;</span><span class="p">);</span>
<a name="line-1147"></a>
<a name="line-1148"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">debugger_env</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
<a name="line-1149"></a>    <span class="k">return</span> <span class="n">EXCEPTION_CONTINUE_SEARCH</span><span class="p">;</span>
<a name="line-1150"></a>
<a name="line-1151"></a>  <span class="cm">/* Create an inheritable event */</span>
<a name="line-1152"></a>  <span class="n">memset</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">si</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">si</span><span class="p">));</span>
<a name="line-1153"></a>  <span class="n">memset</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">pi</span><span class="p">));</span>
<a name="line-1154"></a>  <span class="n">memset</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">sa</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">sa</span><span class="p">));</span>
<a name="line-1155"></a>  <span class="n">si</span><span class="p">.</span><span class="n">cb</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">si</span><span class="p">);</span>
<a name="line-1156"></a>  <span class="n">sa</span><span class="p">.</span><span class="n">nLength</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">sa</span><span class="p">);</span>
<a name="line-1157"></a>  <span class="n">sa</span><span class="p">.</span><span class="n">bInheritHandle</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
<a name="line-1158"></a>  <span class="n">event</span> <span class="o">=</span> <span class="n">CreateEvent</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">sa</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<a name="line-1159"></a>
<a name="line-1160"></a>  <span class="cm">/* Put process ID and event handle into debugger commandline */</span>
<a name="line-1161"></a>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_g_win32_subst_pid_and_event</span> <span class="p">(</span><span class="n">debugger</span><span class="p">,</span> <span class="n">G_N_ELEMENTS</span> <span class="p">(</span><span class="n">debugger</span><span class="p">),</span>
<a name="line-1162"></a>                                     <span class="n">debugger_env</span><span class="p">,</span> <span class="n">GetCurrentProcessId</span> <span class="p">(),</span>
<a name="line-1163"></a>                                     <span class="p">(</span><span class="n">guintptr</span><span class="p">)</span> <span class="n">event</span><span class="p">))</span>
<a name="line-1164"></a>    <span class="p">{</span>
<a name="line-1165"></a>      <span class="n">CloseHandle</span> <span class="p">(</span><span class="n">event</span><span class="p">);</span>
<a name="line-1166"></a>      <span class="k">return</span> <span class="n">EXCEPTION_CONTINUE_SEARCH</span><span class="p">;</span>
<a name="line-1167"></a>    <span class="p">}</span>
<a name="line-1168"></a>
<a name="line-1169"></a>  <span class="cm">/* Run the debugger */</span>
<a name="line-1170"></a>  <span class="n">debugger</span><span class="p">[</span><span class="n">MAX_PATH</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
<a name="line-1171"></a>  <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">CreateProcessA</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">,</span>
<a name="line-1172"></a>                           <span class="n">debugger</span><span class="p">,</span>
<a name="line-1173"></a>                           <span class="nb">NULL</span><span class="p">,</span>
<a name="line-1174"></a>                           <span class="nb">NULL</span><span class="p">,</span>
<a name="line-1175"></a>                           <span class="n">TRUE</span><span class="p">,</span>
<a name="line-1176"></a>                           <span class="n">g_getenv</span> <span class="p">(</span><span class="s">&quot;G_DEBUGGER_OLD_CONSOLE&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">CREATE_NEW_CONSOLE</span><span class="p">,</span>
<a name="line-1177"></a>                           <span class="nb">NULL</span><span class="p">,</span>
<a name="line-1178"></a>                           <span class="nb">NULL</span><span class="p">,</span>
<a name="line-1179"></a>                           <span class="o">&amp;</span><span class="n">si</span><span class="p">,</span>
<a name="line-1180"></a>                           <span class="o">&amp;</span><span class="n">pi</span><span class="p">))</span>
<a name="line-1181"></a>    <span class="p">{</span>
<a name="line-1182"></a>      <span class="n">CloseHandle</span> <span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hProcess</span><span class="p">);</span>
<a name="line-1183"></a>      <span class="n">CloseHandle</span> <span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hThread</span><span class="p">);</span>
<a name="line-1184"></a>      <span class="cm">/* If successful, wait for 60 seconds on the event</span>
<a name="line-1185"></a><span class="cm">       * we passed. The debugger should signal that event.</span>
<a name="line-1186"></a><span class="cm">       * 60 second limit is here to prevent us from hanging</span>
<a name="line-1187"></a><span class="cm">       * up forever in case the debugger does not support</span>
<a name="line-1188"></a><span class="cm">       * event signalling.</span>
<a name="line-1189"></a><span class="cm">       */</span>
<a name="line-1190"></a>      <span class="n">WaitForSingleObject</span> <span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="mi">60000</span><span class="p">);</span>
<a name="line-1191"></a>    <span class="p">}</span>
<a name="line-1192"></a>
<a name="line-1193"></a>  <span class="n">CloseHandle</span> <span class="p">(</span><span class="n">event</span><span class="p">);</span>
<a name="line-1194"></a>
<a name="line-1195"></a>  <span class="cm">/* Now the debugger is present, and we can try</span>
<a name="line-1196"></a><span class="cm">   * resuming execution, re-triggering the exception,</span>
<a name="line-1197"></a><span class="cm">   * which will be caught by debugger this time around.</span>
<a name="line-1198"></a><span class="cm">   */</span>
<a name="line-1199"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">IsDebuggerPresent</span> <span class="p">())</span>
<a name="line-1200"></a>    <span class="k">return</span> <span class="n">EXCEPTION_CONTINUE_EXECUTION</span><span class="p">;</span>
<a name="line-1201"></a>
<a name="line-1202"></a>  <span class="k">return</span> <span class="n">EXCEPTION_CONTINUE_SEARCH</span><span class="p">;</span>
<a name="line-1203"></a><span class="p">}</span>
<a name="line-1204"></a>
<a name="line-1205"></a><span class="kt">void</span>
<a name="line-1206"></a><span class="n">g_crash_handler_win32_init</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<a name="line-1207"></a><span class="p">{</span>
<a name="line-1208"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">WinVEH_handle</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
<a name="line-1209"></a>    <span class="k">return</span><span class="p">;</span>
<a name="line-1210"></a>
<a name="line-1211"></a>  <span class="cm">/* Do not register an exception handler if we&#39;re not supposed to catch any</span>
<a name="line-1212"></a><span class="cm">   * exceptions. Exception handlers are considered dangerous to use, and can</span>
<a name="line-1213"></a><span class="cm">   * break advanced exception handling such as in CLRs like C# or other managed</span>
<a name="line-1214"></a><span class="cm">   * code. See: https://blogs.msdn.microsoft.com/jmstall/2006/05/24/beware-of-the-vectored-exception-handler-and-managed-code/</span>
<a name="line-1215"></a><span class="cm">   */</span>
<a name="line-1216"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">g_getenv</span> <span class="p">(</span><span class="s">&quot;G_DEBUGGER&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">g_getenv</span><span class="p">(</span><span class="s">&quot;G_VEH_CATCH&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
<a name="line-1217"></a>    <span class="k">return</span><span class="p">;</span>
<a name="line-1218"></a>
<a name="line-1219"></a>  <span class="n">WinVEH_handle</span> <span class="o">=</span> <span class="n">AddVectoredExceptionHandler</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">g_win32_veh_handler</span><span class="p">);</span>
<a name="line-1220"></a><span class="p">}</span>
<a name="line-1221"></a>
<a name="line-1222"></a><span class="kt">void</span>
<a name="line-1223"></a><span class="n">g_crash_handler_win32_deinit</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<a name="line-1224"></a><span class="p">{</span>
<a name="line-1225"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">WinVEH_handle</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
<a name="line-1226"></a>    <span class="n">RemoveVectoredExceptionHandler</span> <span class="p">(</span><span class="n">WinVEH_handle</span><span class="p">);</span>
<a name="line-1227"></a>
<a name="line-1228"></a>  <span class="n">WinVEH_handle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="line-1229"></a><span class="p">}</span>
<a name="line-1230"></a>
<a name="line-1231"></a><span class="cp">#endif</span>
</pre></div>
</td></tr></table>
      </div> <!-- /.wrapper -->
    </div>
    <div id="footer" class="footer">
      <p>
        Cppcheck 2.3 - a tool for static C/C++ code analysis<br>
        <br>
        Internet: <a href="http://cppcheck.net">http://cppcheck.net</a><br>
        IRC: <a href="irc://irc.freenode.net/cppcheck">irc://irc.freenode.net/cppcheck</a><br>
      </p>
    </div>
  </body>
</html>
