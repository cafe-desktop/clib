
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Cppcheck - HTML report - clib (cppcheck 2.3-1)</title>
    <link rel="stylesheet" href="style.css">
    <style>
pre { line-height: 125%; margin: 0; }
td.linenos pre { color: #000000; background-color: #f0f0f0; padding: 0 5px 0 5px; }
span.linenos { color: #000000; background-color: #f0f0f0; padding: 0 5px 0 5px; }
td.linenos pre.special { color: #000000; background-color: #ffffc0; padding: 0 5px 0 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding: 0 5px 0 5px; }
.highlight .hll { background-color: #ffffcc }
.highlight { background: #ffffff; }
.highlight .c { color: #888888 } /* Comment */
.highlight .err { color: #FF0000; background-color: #FFAAAA } /* Error */
.highlight .k { color: #008800; font-weight: bold } /* Keyword */
.highlight .o { color: #333333 } /* Operator */
.highlight .ch { color: #888888 } /* Comment.Hashbang */
.highlight .cm { color: #888888 } /* Comment.Multiline */
.highlight .cp { color: #557799 } /* Comment.Preproc */
.highlight .cpf { color: #888888 } /* Comment.PreprocFile */
.highlight .c1 { color: #888888 } /* Comment.Single */
.highlight .cs { color: #cc0000; font-weight: bold } /* Comment.Special */
.highlight .gd { color: #A00000 } /* Generic.Deleted */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gr { color: #FF0000 } /* Generic.Error */
.highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.highlight .gi { color: #00A000 } /* Generic.Inserted */
.highlight .go { color: #888888 } /* Generic.Output */
.highlight .gp { color: #c65d09; font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.highlight .gt { color: #0044DD } /* Generic.Traceback */
.highlight .kc { color: #008800; font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: #008800; font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: #008800; font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: #003388; font-weight: bold } /* Keyword.Pseudo */
.highlight .kr { color: #008800; font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #333399; font-weight: bold } /* Keyword.Type */
.highlight .m { color: #6600EE; font-weight: bold } /* Literal.Number */
.highlight .s { background-color: #fff0f0 } /* Literal.String */
.highlight .na { color: #0000CC } /* Name.Attribute */
.highlight .nb { color: #007020 } /* Name.Builtin */
.highlight .nc { color: #BB0066; font-weight: bold } /* Name.Class */
.highlight .no { color: #003366; font-weight: bold } /* Name.Constant */
.highlight .nd { color: #555555; font-weight: bold } /* Name.Decorator */
.highlight .ni { color: #880000; font-weight: bold } /* Name.Entity */
.highlight .ne { color: #FF0000; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #0066BB; font-weight: bold } /* Name.Function */
.highlight .nl { color: #997700; font-weight: bold } /* Name.Label */
.highlight .nn { color: #0e84b5; font-weight: bold } /* Name.Namespace */
.highlight .nt { color: #007700 } /* Name.Tag */
.highlight .nv { color: #996633 } /* Name.Variable */
.highlight .ow { color: #000000; font-weight: bold } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mb { color: #6600EE; font-weight: bold } /* Literal.Number.Bin */
.highlight .mf { color: #6600EE; font-weight: bold } /* Literal.Number.Float */
.highlight .mh { color: #005588; font-weight: bold } /* Literal.Number.Hex */
.highlight .mi { color: #0000DD; font-weight: bold } /* Literal.Number.Integer */
.highlight .mo { color: #4400EE; font-weight: bold } /* Literal.Number.Oct */
.highlight .sa { background-color: #fff0f0 } /* Literal.String.Affix */
.highlight .sb { background-color: #fff0f0 } /* Literal.String.Backtick */
.highlight .sc { color: #0044DD } /* Literal.String.Char */
.highlight .dl { background-color: #fff0f0 } /* Literal.String.Delimiter */
.highlight .sd { color: #DD4422 } /* Literal.String.Doc */
.highlight .s2 { background-color: #fff0f0 } /* Literal.String.Double */
.highlight .se { color: #666666; font-weight: bold; background-color: #fff0f0 } /* Literal.String.Escape */
.highlight .sh { background-color: #fff0f0 } /* Literal.String.Heredoc */
.highlight .si { background-color: #eeeeee } /* Literal.String.Interpol */
.highlight .sx { color: #DD2200; background-color: #fff0f0 } /* Literal.String.Other */
.highlight .sr { color: #000000; background-color: #fff0ff } /* Literal.String.Regex */
.highlight .s1 { background-color: #fff0f0 } /* Literal.String.Single */
.highlight .ss { color: #AA6600 } /* Literal.String.Symbol */
.highlight .bp { color: #007020 } /* Name.Builtin.Pseudo */
.highlight .fm { color: #0066BB; font-weight: bold } /* Name.Function.Magic */
.highlight .vc { color: #336699 } /* Name.Variable.Class */
.highlight .vg { color: #dd7700; font-weight: bold } /* Name.Variable.Global */
.highlight .vi { color: #3333BB } /* Name.Variable.Instance */
.highlight .vm { color: #996633 } /* Name.Variable.Magic */
.highlight .il { color: #0000DD; font-weight: bold } /* Literal.Number.Integer.Long */
    </style>
    <script>
      function getStyle(el, styleProp) {
        var y;

        if (el.currentStyle) {
          y = el.currentStyle[styleProp];
        } else if (window.getComputedStyle) {
          y = document.defaultView.getComputedStyle(el, null).getPropertyValue(styleProp);
        }

        return y;
      }

      function toggle() {
        var el = this.expandable_content;
        var mark = this.expandable_marker;

        if (el.style.display === "block") {
          el.style.display = "none";
          mark.textContent = "[+]";
        } else {
          el.style.display = "block";
          mark.textContent = "[-]";
        }
      }

      function initExpandables() {
        var elements = document.querySelectorAll(".expandable");

        for (var i = 0, len = elements.length; i < len; i++) {
          var el = elements[i];
          var clickable = el.querySelector("span");
          var marker = clickable.querySelector(".marker");
          var content = el.querySelector(".content");
          var width = clickable.clientWidth - parseInt(getStyle(content, "padding-left")) - parseInt(getStyle(content, "padding-right"));
          content.style.width = width + "px";
          clickable.expandable_content = content;
          clickable.expandable_marker = marker;
          clickable.addEventListener("click", toggle);
        }
      }

      function toggleDisplay(id) {
        var elements = document.querySelectorAll("." + id);

        for (var i = 0, len = elements.length; i < len; i++) {
          elements[i].classList.toggle("d-none");
        }
      }

      function toggleAll() {
        var elements = document.querySelectorAll("input");

        // starting from 1 since 0 is the "toggle all" input
        for (var i = 1, len = elements.length; i < len; i++) {
          var el = elements[i];

          if (el.checked) {
            el.checked = false;
          } else {
            el.checked = true;
          }

          toggleDisplay(el.id);
        }
      }
      window.addEventListener("load", initExpandables);
    </script>
  </head>
  <body>
    <div id="header" class="header">
      <h1>Cppcheck report - clib (cppcheck 2.3-1): glib/glib-unix.c</h1>
    </div>
    <div class="wrapper">
      <div id="menu">
       <p id="filename"><a href="index.html">Defects:</a> glib-unix.c</p>
<a href="267.html#line-0"> noValidConfiguration 0</a>
    </div>
    <div id="content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456
457
458
459
460
461
462
463
464
465
466
467
468
469
470
471
472
473
474
475
476
477
478
479
480
481
482
483
484
485
486
487
488
489
490
491
492
493
494
495
496
497
498
499
500
501
502
503
504
505
506
507
508
509
510
511
512
513
514
515
516
517
518
519
520
521
522
523
524
525
526
527
528
529
530
531
532
533
534
535
536
537
538
539
540
541
542
543
544</pre></div></td><td class="code"><div class="highlight"><pre><span></span><a name="line-1"></a><span class="cm">/* GLIB - Library of useful routines for C programming</span>
<a name="line-2"></a><span class="cm"> * Copyright (C) 2011 Red Hat, Inc.</span>
<a name="line-3"></a><span class="cm"> *</span>
<a name="line-4"></a><span class="cm"> * glib-unix.c: UNIX specific API wrappers and convenience functions</span>
<a name="line-5"></a><span class="cm"> *</span>
<a name="line-6"></a><span class="cm"> * This library is free software; you can redistribute it and/or</span>
<a name="line-7"></a><span class="cm"> * modify it under the terms of the GNU Lesser General Public</span>
<a name="line-8"></a><span class="cm"> * License as published by the Free Software Foundation; either</span>
<a name="line-9"></a><span class="cm"> * version 2.1 of the License, or (at your option) any later version.</span>
<a name="line-10"></a><span class="cm"> *</span>
<a name="line-11"></a><span class="cm"> * This library is distributed in the hope that it will be useful,</span>
<a name="line-12"></a><span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="line-13"></a><span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<a name="line-14"></a><span class="cm"> * Lesser General Public License for more details.</span>
<a name="line-15"></a><span class="cm"> *</span>
<a name="line-16"></a><span class="cm"> * You should have received a copy of the GNU Lesser General Public</span>
<a name="line-17"></a><span class="cm"> * License along with this library; if not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<a name="line-18"></a><span class="cm"> *</span>
<a name="line-19"></a><span class="cm"> * Authors: Colin Walters &lt;walters@verbum.org&gt;</span>
<a name="line-20"></a><span class="cm"> */</span>
<a name="line-21"></a>
<a name="line-22"></a><span class="cp">#include</span> <span class="cpf">&quot;config.h&quot;</span><span class="cp"></span>
<a name="line-23"></a>
<a name="line-24"></a><span class="cm">/* To make bionic export pipe2() */</span>
<a name="line-25"></a><span class="cp">#ifndef _GNU_SOURCE</span>
<a name="line-26"></a><span class="cp">#define _GNU_SOURCE 1</span>
<a name="line-27"></a><span class="cp">#endif</span>
<a name="line-28"></a>
<a name="line-29"></a><span class="cp">#include</span> <span class="cpf">&quot;glib-unix.h&quot;</span><span class="cp"></span>
<a name="line-30"></a><span class="cp">#include</span> <span class="cpf">&quot;gmain-internal.h&quot;</span><span class="cp"></span>
<a name="line-31"></a>
<a name="line-32"></a><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>
<a name="line-33"></a><span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp"></span>
<a name="line-34"></a><span class="cp">#include</span> <span class="cpf">&lt;pwd.h&gt;</span><span class="cp"></span>
<a name="line-35"></a>
<a name="line-36"></a><span class="cm">/**</span>
<a name="line-37"></a><span class="cm"> * SECTION:gunix</span>
<a name="line-38"></a><span class="cm"> * @title: UNIX-specific utilities and integration</span>
<a name="line-39"></a><span class="cm"> * @short_description: pipes, signal handling</span>
<a name="line-40"></a><span class="cm"> * @include: glib-unix.h</span>
<a name="line-41"></a><span class="cm"> *</span>
<a name="line-42"></a><span class="cm"> * Most of GLib is intended to be portable; in contrast, this set of</span>
<a name="line-43"></a><span class="cm"> * functions is designed for programs which explicitly target UNIX,</span>
<a name="line-44"></a><span class="cm"> * or are using it to build higher level abstractions which would be</span>
<a name="line-45"></a><span class="cm"> * conditionally compiled if the platform matches G_OS_UNIX.</span>
<a name="line-46"></a><span class="cm"> *</span>
<a name="line-47"></a><span class="cm"> * To use these functions, you must explicitly include the</span>
<a name="line-48"></a><span class="cm"> * &quot;glib-unix.h&quot; header.</span>
<a name="line-49"></a><span class="cm"> */</span>
<a name="line-50"></a>
<a name="line-51"></a><span class="n">G_DEFINE_QUARK</span> <span class="p">(</span><span class="n">g</span><span class="o">-</span><span class="n">unix</span><span class="o">-</span><span class="n">error</span><span class="o">-</span><span class="n">quark</span><span class="p">,</span> <span class="n">g_unix_error</span><span class="p">)</span>
<a name="line-52"></a>
<a name="line-53"></a><span class="k">static</span> <span class="n">gboolean</span>
<a name="line-54"></a><span class="n">g_unix_set_error_from_errno</span> <span class="p">(</span><span class="n">GError</span> <span class="o">**</span><span class="n">error</span><span class="p">,</span>
<a name="line-55"></a>                             <span class="n">gint</span>     <span class="n">saved_errno</span><span class="p">)</span>
<a name="line-56"></a><span class="p">{</span>
<a name="line-57"></a>  <span class="n">g_set_error_literal</span> <span class="p">(</span><span class="n">error</span><span class="p">,</span>
<a name="line-58"></a>                       <span class="n">G_UNIX_ERROR</span><span class="p">,</span>
<a name="line-59"></a>                       <span class="mi">0</span><span class="p">,</span>
<a name="line-60"></a>                       <span class="n">g_strerror</span> <span class="p">(</span><span class="n">saved_errno</span><span class="p">));</span>
<a name="line-61"></a>  <span class="n">errno</span> <span class="o">=</span> <span class="n">saved_errno</span><span class="p">;</span>
<a name="line-62"></a>  <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
<a name="line-63"></a><span class="p">}</span>
<a name="line-64"></a>
<a name="line-65"></a><span class="cm">/**</span>
<a name="line-66"></a><span class="cm"> * g_unix_open_pipe:</span>
<a name="line-67"></a><span class="cm"> * @fds: Array of two integers</span>
<a name="line-68"></a><span class="cm"> * @flags: Bitfield of file descriptor flags, as for fcntl()</span>
<a name="line-69"></a><span class="cm"> * @error: a #GError</span>
<a name="line-70"></a><span class="cm"> *</span>
<a name="line-71"></a><span class="cm"> * Similar to the UNIX pipe() call, but on modern systems like Linux</span>
<a name="line-72"></a><span class="cm"> * uses the pipe2() system call, which atomically creates a pipe with</span>
<a name="line-73"></a><span class="cm"> * the configured flags. The only supported flag currently is</span>
<a name="line-74"></a><span class="cm"> * %FD_CLOEXEC. If for example you want to configure %O_NONBLOCK, that</span>
<a name="line-75"></a><span class="cm"> * must still be done separately with fcntl().</span>
<a name="line-76"></a><span class="cm"> *</span>
<a name="line-77"></a><span class="cm"> * This function does not take %O_CLOEXEC, it takes %FD_CLOEXEC as if</span>
<a name="line-78"></a><span class="cm"> * for fcntl(); these are different on Linux/glibc.</span>
<a name="line-79"></a><span class="cm"> *</span>
<a name="line-80"></a><span class="cm"> * Returns: %TRUE on success, %FALSE if not (and errno will be set).</span>
<a name="line-81"></a><span class="cm"> *</span>
<a name="line-82"></a><span class="cm"> * Since: 2.30</span>
<a name="line-83"></a><span class="cm"> */</span>
<a name="line-84"></a><span class="n">gboolean</span>
<a name="line-85"></a><span class="n">g_unix_open_pipe</span> <span class="p">(</span><span class="kt">int</span>     <span class="o">*</span><span class="n">fds</span><span class="p">,</span>
<a name="line-86"></a>                  <span class="kt">int</span>      <span class="n">flags</span><span class="p">,</span>
<a name="line-87"></a>                  <span class="n">GError</span> <span class="o">**</span><span class="n">error</span><span class="p">)</span>
<a name="line-88"></a><span class="p">{</span>
<a name="line-89"></a>  <span class="kt">int</span> <span class="n">ecode</span><span class="p">;</span>
<a name="line-90"></a>
<a name="line-91"></a>  <span class="cm">/* We only support FD_CLOEXEC */</span>
<a name="line-92"></a>  <span class="n">g_return_val_if_fail</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FD_CLOEXEC</span><span class="p">))</span> <span class="o">==</span> <span class="n">flags</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">);</span>
<a name="line-93"></a>
<a name="line-94"></a><span class="cp">#ifdef HAVE_PIPE2</span>
<a name="line-95"></a>  <span class="p">{</span>
<a name="line-96"></a>    <span class="kt">int</span> <span class="n">pipe2_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="line-97"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FD_CLOEXEC</span><span class="p">)</span>
<a name="line-98"></a>      <span class="n">pipe2_flags</span> <span class="o">|=</span> <span class="n">O_CLOEXEC</span><span class="p">;</span>
<a name="line-99"></a>    <span class="cm">/* Atomic */</span>
<a name="line-100"></a>    <span class="n">ecode</span> <span class="o">=</span> <span class="n">pipe2</span> <span class="p">(</span><span class="n">fds</span><span class="p">,</span> <span class="n">pipe2_flags</span><span class="p">);</span>
<a name="line-101"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">ecode</span> <span class="o">==</span> <span class="mi">-1</span> <span class="o">&amp;&amp;</span> <span class="n">errno</span> <span class="o">!=</span> <span class="n">ENOSYS</span><span class="p">)</span>
<a name="line-102"></a>      <span class="k">return</span> <span class="n">g_unix_set_error_from_errno</span> <span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">errno</span><span class="p">);</span>
<a name="line-103"></a>    <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">ecode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="line-104"></a>      <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<a name="line-105"></a>    <span class="cm">/* Fall through on -ENOSYS, we must be running on an old kernel */</span>
<a name="line-106"></a>  <span class="p">}</span>
<a name="line-107"></a><span class="cp">#endif</span>
<a name="line-108"></a>  <span class="n">ecode</span> <span class="o">=</span> <span class="n">pipe</span> <span class="p">(</span><span class="n">fds</span><span class="p">);</span>
<a name="line-109"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">ecode</span> <span class="o">==</span> <span class="mi">-1</span><span class="p">)</span>
<a name="line-110"></a>    <span class="k">return</span> <span class="n">g_unix_set_error_from_errno</span> <span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">errno</span><span class="p">);</span>
<a name="line-111"></a>
<a name="line-112"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="line-113"></a>    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<a name="line-114"></a>
<a name="line-115"></a>  <span class="n">ecode</span> <span class="o">=</span> <span class="n">fcntl</span> <span class="p">(</span><span class="n">fds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">F_SETFD</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<a name="line-116"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">ecode</span> <span class="o">==</span> <span class="mi">-1</span><span class="p">)</span>
<a name="line-117"></a>    <span class="p">{</span>
<a name="line-118"></a>      <span class="kt">int</span> <span class="n">saved_errno</span> <span class="o">=</span> <span class="n">errno</span><span class="p">;</span>
<a name="line-119"></a>      <span class="n">close</span> <span class="p">(</span><span class="n">fds</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<a name="line-120"></a>      <span class="n">close</span> <span class="p">(</span><span class="n">fds</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<a name="line-121"></a>      <span class="k">return</span> <span class="nf">g_unix_set_error_from_errno</span> <span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">saved_errno</span><span class="p">);</span>
<a name="line-122"></a>    <span class="p">}</span>
<a name="line-123"></a>  <span class="n">ecode</span> <span class="o">=</span> <span class="n">fcntl</span> <span class="p">(</span><span class="n">fds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">F_SETFD</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<a name="line-124"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">ecode</span> <span class="o">==</span> <span class="mi">-1</span><span class="p">)</span>
<a name="line-125"></a>    <span class="p">{</span>
<a name="line-126"></a>      <span class="kt">int</span> <span class="n">saved_errno</span> <span class="o">=</span> <span class="n">errno</span><span class="p">;</span>
<a name="line-127"></a>      <span class="n">close</span> <span class="p">(</span><span class="n">fds</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<a name="line-128"></a>      <span class="n">close</span> <span class="p">(</span><span class="n">fds</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<a name="line-129"></a>      <span class="k">return</span> <span class="nf">g_unix_set_error_from_errno</span> <span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">saved_errno</span><span class="p">);</span>
<a name="line-130"></a>    <span class="p">}</span>
<a name="line-131"></a>  <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<a name="line-132"></a><span class="p">}</span>
<a name="line-133"></a>
<a name="line-134"></a><span class="cm">/**</span>
<a name="line-135"></a><span class="cm"> * g_unix_set_fd_nonblocking:</span>
<a name="line-136"></a><span class="cm"> * @fd: A file descriptor</span>
<a name="line-137"></a><span class="cm"> * @nonblock: If %TRUE, set the descriptor to be non-blocking</span>
<a name="line-138"></a><span class="cm"> * @error: a #GError</span>
<a name="line-139"></a><span class="cm"> *</span>
<a name="line-140"></a><span class="cm"> * Control the non-blocking state of the given file descriptor,</span>
<a name="line-141"></a><span class="cm"> * according to @nonblock. On most systems this uses %O_NONBLOCK, but</span>
<a name="line-142"></a><span class="cm"> * on some older ones may use %O_NDELAY.</span>
<a name="line-143"></a><span class="cm"> *</span>
<a name="line-144"></a><span class="cm"> * Returns: %TRUE if successful</span>
<a name="line-145"></a><span class="cm"> *</span>
<a name="line-146"></a><span class="cm"> * Since: 2.30</span>
<a name="line-147"></a><span class="cm"> */</span>
<a name="line-148"></a><span class="n">gboolean</span>
<a name="line-149"></a><span class="n">g_unix_set_fd_nonblocking</span> <span class="p">(</span><span class="n">gint</span>       <span class="n">fd</span><span class="p">,</span>
<a name="line-150"></a>                           <span class="n">gboolean</span>   <span class="n">nonblock</span><span class="p">,</span>
<a name="line-151"></a>                           <span class="n">GError</span>   <span class="o">**</span><span class="n">error</span><span class="p">)</span>
<a name="line-152"></a><span class="p">{</span>
<a name="line-153"></a><span class="cp">#ifdef F_GETFL</span>
<a name="line-154"></a>  <span class="n">glong</span> <span class="n">fcntl_flags</span><span class="p">;</span>
<a name="line-155"></a>  <span class="n">fcntl_flags</span> <span class="o">=</span> <span class="n">fcntl</span> <span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">F_GETFL</span><span class="p">);</span>
<a name="line-156"></a>
<a name="line-157"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">fcntl_flags</span> <span class="o">==</span> <span class="mi">-1</span><span class="p">)</span>
<a name="line-158"></a>    <span class="k">return</span> <span class="n">g_unix_set_error_from_errno</span> <span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">errno</span><span class="p">);</span>
<a name="line-159"></a>
<a name="line-160"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">nonblock</span><span class="p">)</span>
<a name="line-161"></a>    <span class="p">{</span>
<a name="line-162"></a><span class="cp">#ifdef O_NONBLOCK</span>
<a name="line-163"></a>      <span class="n">fcntl_flags</span> <span class="o">|=</span> <span class="n">O_NONBLOCK</span><span class="p">;</span>
<a name="line-164"></a><span class="cp">#else</span>
<a name="line-165"></a>      <span class="n">fcntl_flags</span> <span class="o">|=</span> <span class="n">O_NDELAY</span><span class="p">;</span>
<a name="line-166"></a><span class="cp">#endif</span>
<a name="line-167"></a>    <span class="p">}</span>
<a name="line-168"></a>  <span class="k">else</span>
<a name="line-169"></a>    <span class="p">{</span>
<a name="line-170"></a><span class="cp">#ifdef O_NONBLOCK</span>
<a name="line-171"></a>      <span class="n">fcntl_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">O_NONBLOCK</span><span class="p">;</span>
<a name="line-172"></a><span class="cp">#else</span>
<a name="line-173"></a>      <span class="n">fcntl_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">O_NDELAY</span><span class="p">;</span>
<a name="line-174"></a><span class="cp">#endif</span>
<a name="line-175"></a>    <span class="p">}</span>
<a name="line-176"></a>
<a name="line-177"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">fcntl</span> <span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">F_SETFL</span><span class="p">,</span> <span class="n">fcntl_flags</span><span class="p">)</span> <span class="o">==</span> <span class="mi">-1</span><span class="p">)</span>
<a name="line-178"></a>    <span class="k">return</span> <span class="n">g_unix_set_error_from_errno</span> <span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">errno</span><span class="p">);</span>
<a name="line-179"></a>  <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<a name="line-180"></a><span class="cp">#else</span>
<a name="line-181"></a>  <span class="k">return</span> <span class="nf">g_unix_set_error_from_errno</span> <span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">EINVAL</span><span class="p">);</span>
<a name="line-182"></a><span class="cp">#endif</span>
<a name="line-183"></a><span class="p">}</span>
<a name="line-184"></a>
<a name="line-185"></a><span class="cm">/**</span>
<a name="line-186"></a><span class="cm"> * g_unix_signal_source_new:</span>
<a name="line-187"></a><span class="cm"> * @signum: A signal number</span>
<a name="line-188"></a><span class="cm"> *</span>
<a name="line-189"></a><span class="cm"> * Create a #GSource that will be dispatched upon delivery of the UNIX</span>
<a name="line-190"></a><span class="cm"> * signal @signum.  In GLib versions before 2.36, only `SIGHUP`, `SIGINT`,</span>
<a name="line-191"></a><span class="cm"> * `SIGTERM` can be monitored.  In GLib 2.36, `SIGUSR1` and `SIGUSR2`</span>
<a name="line-192"></a><span class="cm"> * were added. In GLib 2.54, `SIGWINCH` was added.</span>
<a name="line-193"></a><span class="cm"> *</span>
<a name="line-194"></a><span class="cm"> * Note that unlike the UNIX default, all sources which have created a</span>
<a name="line-195"></a><span class="cm"> * watch will be dispatched, regardless of which underlying thread</span>
<a name="line-196"></a><span class="cm"> * invoked g_unix_signal_source_new().</span>
<a name="line-197"></a><span class="cm"> *</span>
<a name="line-198"></a><span class="cm"> * For example, an effective use of this function is to handle `SIGTERM`</span>
<a name="line-199"></a><span class="cm"> * cleanly; flushing any outstanding files, and then calling</span>
<a name="line-200"></a><span class="cm"> * g_main_loop_quit ().  It is not safe to do any of this a regular</span>
<a name="line-201"></a><span class="cm"> * UNIX signal handler; your handler may be invoked while malloc() or</span>
<a name="line-202"></a><span class="cm"> * another library function is running, causing reentrancy if you</span>
<a name="line-203"></a><span class="cm"> * attempt to use it from the handler.  None of the GLib/GObject API</span>
<a name="line-204"></a><span class="cm"> * is safe against this kind of reentrancy.</span>
<a name="line-205"></a><span class="cm"> *</span>
<a name="line-206"></a><span class="cm"> * The interaction of this source when combined with native UNIX</span>
<a name="line-207"></a><span class="cm"> * functions like sigprocmask() is not defined.</span>
<a name="line-208"></a><span class="cm"> *</span>
<a name="line-209"></a><span class="cm"> * The source will not initially be associated with any #GMainContext</span>
<a name="line-210"></a><span class="cm"> * and must be added to one with g_source_attach() before it will be</span>
<a name="line-211"></a><span class="cm"> * executed.</span>
<a name="line-212"></a><span class="cm"> *</span>
<a name="line-213"></a><span class="cm"> * Returns: A newly created #GSource</span>
<a name="line-214"></a><span class="cm"> *</span>
<a name="line-215"></a><span class="cm"> * Since: 2.30</span>
<a name="line-216"></a><span class="cm"> */</span>
<a name="line-217"></a><span class="n">GSource</span> <span class="o">*</span>
<a name="line-218"></a><span class="n">g_unix_signal_source_new</span> <span class="p">(</span><span class="kt">int</span> <span class="n">signum</span><span class="p">)</span>
<a name="line-219"></a><span class="p">{</span>
<a name="line-220"></a>  <span class="n">g_return_val_if_fail</span> <span class="p">(</span><span class="n">signum</span> <span class="o">==</span> <span class="n">SIGHUP</span> <span class="o">||</span> <span class="n">signum</span> <span class="o">==</span> <span class="n">SIGINT</span> <span class="o">||</span> <span class="n">signum</span> <span class="o">==</span> <span class="n">SIGTERM</span> <span class="o">||</span>
<a name="line-221"></a>                        <span class="n">signum</span> <span class="o">==</span> <span class="n">SIGUSR1</span> <span class="o">||</span> <span class="n">signum</span> <span class="o">==</span> <span class="n">SIGUSR2</span> <span class="o">||</span> <span class="n">signum</span> <span class="o">==</span> <span class="n">SIGWINCH</span><span class="p">,</span>
<a name="line-222"></a>                        <span class="nb">NULL</span><span class="p">);</span>
<a name="line-223"></a>
<a name="line-224"></a>  <span class="k">return</span> <span class="nf">_g_main_create_unix_signal_watch</span> <span class="p">(</span><span class="n">signum</span><span class="p">);</span>
<a name="line-225"></a><span class="p">}</span>
<a name="line-226"></a>
<a name="line-227"></a><span class="cm">/**</span>
<a name="line-228"></a><span class="cm"> * g_unix_signal_add_full: (rename-to g_unix_signal_add)</span>
<a name="line-229"></a><span class="cm"> * @priority: the priority of the signal source. Typically this will be in</span>
<a name="line-230"></a><span class="cm"> *            the range between #G_PRIORITY_DEFAULT and #G_PRIORITY_HIGH.</span>
<a name="line-231"></a><span class="cm"> * @signum: Signal number</span>
<a name="line-232"></a><span class="cm"> * @handler: Callback</span>
<a name="line-233"></a><span class="cm"> * @user_data: Data for @handler</span>
<a name="line-234"></a><span class="cm"> * @notify: #GDestroyNotify for @handler</span>
<a name="line-235"></a><span class="cm"> *</span>
<a name="line-236"></a><span class="cm"> * A convenience function for g_unix_signal_source_new(), which</span>
<a name="line-237"></a><span class="cm"> * attaches to the default #GMainContext.  You can remove the watch</span>
<a name="line-238"></a><span class="cm"> * using g_source_remove().</span>
<a name="line-239"></a><span class="cm"> *</span>
<a name="line-240"></a><span class="cm"> * Returns: An ID (greater than 0) for the event source</span>
<a name="line-241"></a><span class="cm"> *</span>
<a name="line-242"></a><span class="cm"> * Since: 2.30</span>
<a name="line-243"></a><span class="cm"> */</span>
<a name="line-244"></a><span class="n">guint</span>
<a name="line-245"></a><span class="n">g_unix_signal_add_full</span> <span class="p">(</span><span class="kt">int</span>            <span class="n">priority</span><span class="p">,</span>
<a name="line-246"></a>                        <span class="kt">int</span>            <span class="n">signum</span><span class="p">,</span>
<a name="line-247"></a>                        <span class="n">GSourceFunc</span>    <span class="n">handler</span><span class="p">,</span>
<a name="line-248"></a>                        <span class="n">gpointer</span>       <span class="n">user_data</span><span class="p">,</span>
<a name="line-249"></a>                        <span class="n">GDestroyNotify</span> <span class="n">notify</span><span class="p">)</span>
<a name="line-250"></a><span class="p">{</span>
<a name="line-251"></a>  <span class="n">guint</span> <span class="n">id</span><span class="p">;</span>
<a name="line-252"></a>  <span class="n">GSource</span> <span class="o">*</span><span class="n">source</span><span class="p">;</span>
<a name="line-253"></a>
<a name="line-254"></a>  <span class="n">source</span> <span class="o">=</span> <span class="n">g_unix_signal_source_new</span> <span class="p">(</span><span class="n">signum</span><span class="p">);</span>
<a name="line-255"></a>
<a name="line-256"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">priority</span> <span class="o">!=</span> <span class="n">G_PRIORITY_DEFAULT</span><span class="p">)</span>
<a name="line-257"></a>    <span class="n">g_source_set_priority</span> <span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">priority</span><span class="p">);</span>
<a name="line-258"></a>
<a name="line-259"></a>  <span class="n">g_source_set_callback</span> <span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="n">user_data</span><span class="p">,</span> <span class="n">notify</span><span class="p">);</span>
<a name="line-260"></a>  <span class="n">id</span> <span class="o">=</span> <span class="n">g_source_attach</span> <span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<a name="line-261"></a>  <span class="n">g_source_unref</span> <span class="p">(</span><span class="n">source</span><span class="p">);</span>
<a name="line-262"></a>
<a name="line-263"></a>  <span class="k">return</span> <span class="n">id</span><span class="p">;</span>
<a name="line-264"></a><span class="p">}</span>
<a name="line-265"></a>
<a name="line-266"></a><span class="cm">/**</span>
<a name="line-267"></a><span class="cm"> * g_unix_signal_add:</span>
<a name="line-268"></a><span class="cm"> * @signum: Signal number</span>
<a name="line-269"></a><span class="cm"> * @handler: Callback</span>
<a name="line-270"></a><span class="cm"> * @user_data: Data for @handler</span>
<a name="line-271"></a><span class="cm"> *</span>
<a name="line-272"></a><span class="cm"> * A convenience function for g_unix_signal_source_new(), which</span>
<a name="line-273"></a><span class="cm"> * attaches to the default #GMainContext.  You can remove the watch</span>
<a name="line-274"></a><span class="cm"> * using g_source_remove().</span>
<a name="line-275"></a><span class="cm"> *</span>
<a name="line-276"></a><span class="cm"> * Returns: An ID (greater than 0) for the event source</span>
<a name="line-277"></a><span class="cm"> *</span>
<a name="line-278"></a><span class="cm"> * Since: 2.30</span>
<a name="line-279"></a><span class="cm"> */</span>
<a name="line-280"></a><span class="n">guint</span>
<a name="line-281"></a><span class="n">g_unix_signal_add</span> <span class="p">(</span><span class="kt">int</span>         <span class="n">signum</span><span class="p">,</span>
<a name="line-282"></a>                   <span class="n">GSourceFunc</span> <span class="n">handler</span><span class="p">,</span>
<a name="line-283"></a>                   <span class="n">gpointer</span>    <span class="n">user_data</span><span class="p">)</span>
<a name="line-284"></a><span class="p">{</span>
<a name="line-285"></a>  <span class="k">return</span> <span class="nf">g_unix_signal_add_full</span> <span class="p">(</span><span class="n">G_PRIORITY_DEFAULT</span><span class="p">,</span> <span class="n">signum</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="n">user_data</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<a name="line-286"></a><span class="p">}</span>
<a name="line-287"></a>
<a name="line-288"></a><span class="k">typedef</span> <span class="k">struct</span>
<a name="line-289"></a><span class="p">{</span>
<a name="line-290"></a>  <span class="n">GSource</span> <span class="n">source</span><span class="p">;</span>
<a name="line-291"></a>
<a name="line-292"></a>  <span class="n">gint</span>     <span class="n">fd</span><span class="p">;</span>
<a name="line-293"></a>  <span class="n">gpointer</span> <span class="n">tag</span><span class="p">;</span>
<a name="line-294"></a><span class="p">}</span> <span class="n">GUnixFDSource</span><span class="p">;</span>
<a name="line-295"></a>
<a name="line-296"></a><span class="k">static</span> <span class="n">gboolean</span>
<a name="line-297"></a><span class="n">g_unix_fd_source_dispatch</span> <span class="p">(</span><span class="n">GSource</span>     <span class="o">*</span><span class="n">source</span><span class="p">,</span>
<a name="line-298"></a>                           <span class="n">GSourceFunc</span>  <span class="n">callback</span><span class="p">,</span>
<a name="line-299"></a>                           <span class="n">gpointer</span>     <span class="n">user_data</span><span class="p">)</span>
<a name="line-300"></a><span class="p">{</span>
<a name="line-301"></a>  <span class="n">GUnixFDSource</span> <span class="o">*</span><span class="n">fd_source</span> <span class="o">=</span> <span class="p">(</span><span class="n">GUnixFDSource</span> <span class="o">*</span><span class="p">)</span> <span class="n">source</span><span class="p">;</span>
<a name="line-302"></a>  <span class="n">GUnixFDSourceFunc</span> <span class="n">func</span> <span class="o">=</span> <span class="p">(</span><span class="n">GUnixFDSourceFunc</span><span class="p">)</span> <span class="n">callback</span><span class="p">;</span>
<a name="line-303"></a>
<a name="line-304"></a>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">callback</span><span class="p">)</span>
<a name="line-305"></a>    <span class="p">{</span>
<a name="line-306"></a>      <span class="n">g_warning</span> <span class="p">(</span><span class="s">&quot;GUnixFDSource dispatched without callback. &quot;</span>
<a name="line-307"></a>                 <span class="s">&quot;You must call g_source_set_callback().&quot;</span><span class="p">);</span>
<a name="line-308"></a>      <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
<a name="line-309"></a>    <span class="p">}</span>
<a name="line-310"></a>
<a name="line-311"></a>  <span class="k">return</span> <span class="p">(</span><span class="o">*</span> <span class="n">func</span><span class="p">)</span> <span class="p">(</span><span class="n">fd_source</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">,</span> <span class="n">g_source_query_unix_fd</span> <span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">fd_source</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">),</span> <span class="n">user_data</span><span class="p">);</span>
<a name="line-312"></a><span class="p">}</span>
<a name="line-313"></a>
<a name="line-314"></a><span class="n">GSourceFuncs</span> <span class="n">g_unix_fd_source_funcs</span> <span class="o">=</span> <span class="p">{</span>
<a name="line-315"></a>  <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">g_unix_fd_source_dispatch</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span>
<a name="line-316"></a><span class="p">};</span>
<a name="line-317"></a>
<a name="line-318"></a><span class="cm">/**</span>
<a name="line-319"></a><span class="cm"> * g_unix_fd_source_new:</span>
<a name="line-320"></a><span class="cm"> * @fd: a file descriptor</span>
<a name="line-321"></a><span class="cm"> * @condition: IO conditions to watch for on @fd</span>
<a name="line-322"></a><span class="cm"> *</span>
<a name="line-323"></a><span class="cm"> * Creates a #GSource to watch for a particular IO condition on a file</span>
<a name="line-324"></a><span class="cm"> * descriptor.</span>
<a name="line-325"></a><span class="cm"> *</span>
<a name="line-326"></a><span class="cm"> * The source will never close the fd -- you must do it yourself.</span>
<a name="line-327"></a><span class="cm"> *</span>
<a name="line-328"></a><span class="cm"> * Returns: the newly created #GSource</span>
<a name="line-329"></a><span class="cm"> *</span>
<a name="line-330"></a><span class="cm"> * Since: 2.36</span>
<a name="line-331"></a><span class="cm"> **/</span>
<a name="line-332"></a><span class="n">GSource</span> <span class="o">*</span>
<a name="line-333"></a><span class="nf">g_unix_fd_source_new</span> <span class="p">(</span><span class="n">gint</span>         <span class="n">fd</span><span class="p">,</span>
<a name="line-334"></a>                      <span class="n">GIOCondition</span> <span class="n">condition</span><span class="p">)</span>
<a name="line-335"></a><span class="p">{</span>
<a name="line-336"></a>  <span class="n">GUnixFDSource</span> <span class="o">*</span><span class="n">fd_source</span><span class="p">;</span>
<a name="line-337"></a>  <span class="n">GSource</span> <span class="o">*</span><span class="n">source</span><span class="p">;</span>
<a name="line-338"></a>
<a name="line-339"></a>  <span class="n">source</span> <span class="o">=</span> <span class="n">g_source_new</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">g_unix_fd_source_funcs</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">GUnixFDSource</span><span class="p">));</span>
<a name="line-340"></a>  <span class="n">fd_source</span> <span class="o">=</span> <span class="p">(</span><span class="n">GUnixFDSource</span> <span class="o">*</span><span class="p">)</span> <span class="n">source</span><span class="p">;</span>
<a name="line-341"></a>
<a name="line-342"></a>  <span class="n">fd_source</span><span class="o">-&gt;</span><span class="n">fd</span> <span class="o">=</span> <span class="n">fd</span><span class="p">;</span>
<a name="line-343"></a>  <span class="n">fd_source</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">=</span> <span class="n">g_source_add_unix_fd</span> <span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">condition</span><span class="p">);</span>
<a name="line-344"></a>
<a name="line-345"></a>  <span class="k">return</span> <span class="n">source</span><span class="p">;</span>
<a name="line-346"></a><span class="p">}</span>
<a name="line-347"></a>
<a name="line-348"></a><span class="cm">/**</span>
<a name="line-349"></a><span class="cm"> * g_unix_fd_add_full:</span>
<a name="line-350"></a><span class="cm"> * @priority: the priority of the source</span>
<a name="line-351"></a><span class="cm"> * @fd: a file descriptor</span>
<a name="line-352"></a><span class="cm"> * @condition: IO conditions to watch for on @fd</span>
<a name="line-353"></a><span class="cm"> * @function: a #GUnixFDSourceFunc</span>
<a name="line-354"></a><span class="cm"> * @user_data: data to pass to @function</span>
<a name="line-355"></a><span class="cm"> * @notify: function to call when the idle is removed, or %NULL</span>
<a name="line-356"></a><span class="cm"> *</span>
<a name="line-357"></a><span class="cm"> * Sets a function to be called when the IO condition, as specified by</span>
<a name="line-358"></a><span class="cm"> * @condition becomes true for @fd.</span>
<a name="line-359"></a><span class="cm"> *</span>
<a name="line-360"></a><span class="cm"> * This is the same as g_unix_fd_add(), except that it allows you to</span>
<a name="line-361"></a><span class="cm"> * specify a non-default priority and a provide a #GDestroyNotify for</span>
<a name="line-362"></a><span class="cm"> * @user_data.</span>
<a name="line-363"></a><span class="cm"> *</span>
<a name="line-364"></a><span class="cm"> * Returns: the ID (greater than 0) of the event source</span>
<a name="line-365"></a><span class="cm"> *</span>
<a name="line-366"></a><span class="cm"> * Since: 2.36</span>
<a name="line-367"></a><span class="cm"> **/</span>
<a name="line-368"></a><span class="n">guint</span>
<a name="line-369"></a><span class="nf">g_unix_fd_add_full</span> <span class="p">(</span><span class="n">gint</span>              <span class="n">priority</span><span class="p">,</span>
<a name="line-370"></a>                    <span class="n">gint</span>              <span class="n">fd</span><span class="p">,</span>
<a name="line-371"></a>                    <span class="n">GIOCondition</span>      <span class="n">condition</span><span class="p">,</span>
<a name="line-372"></a>                    <span class="n">GUnixFDSourceFunc</span> <span class="n">function</span><span class="p">,</span>
<a name="line-373"></a>                    <span class="n">gpointer</span>          <span class="n">user_data</span><span class="p">,</span>
<a name="line-374"></a>                    <span class="n">GDestroyNotify</span>    <span class="n">notify</span><span class="p">)</span>
<a name="line-375"></a><span class="p">{</span>
<a name="line-376"></a>  <span class="n">GSource</span> <span class="o">*</span><span class="n">source</span><span class="p">;</span>
<a name="line-377"></a>  <span class="n">guint</span> <span class="n">id</span><span class="p">;</span>
<a name="line-378"></a>
<a name="line-379"></a>  <span class="n">g_return_val_if_fail</span> <span class="p">(</span><span class="n">function</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="line-380"></a>
<a name="line-381"></a>  <span class="n">source</span> <span class="o">=</span> <span class="n">g_unix_fd_source_new</span> <span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">condition</span><span class="p">);</span>
<a name="line-382"></a>
<a name="line-383"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">priority</span> <span class="o">!=</span> <span class="n">G_PRIORITY_DEFAULT</span><span class="p">)</span>
<a name="line-384"></a>    <span class="n">g_source_set_priority</span> <span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">priority</span><span class="p">);</span>
<a name="line-385"></a>
<a name="line-386"></a>  <span class="n">g_source_set_callback</span> <span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="p">(</span><span class="n">GSourceFunc</span><span class="p">)</span> <span class="n">function</span><span class="p">,</span> <span class="n">user_data</span><span class="p">,</span> <span class="n">notify</span><span class="p">);</span>
<a name="line-387"></a>  <span class="n">id</span> <span class="o">=</span> <span class="n">g_source_attach</span> <span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<a name="line-388"></a>  <span class="n">g_source_unref</span> <span class="p">(</span><span class="n">source</span><span class="p">);</span>
<a name="line-389"></a>
<a name="line-390"></a>  <span class="k">return</span> <span class="n">id</span><span class="p">;</span>
<a name="line-391"></a><span class="p">}</span>
<a name="line-392"></a>
<a name="line-393"></a><span class="cm">/**</span>
<a name="line-394"></a><span class="cm"> * g_unix_fd_add:</span>
<a name="line-395"></a><span class="cm"> * @fd: a file descriptor</span>
<a name="line-396"></a><span class="cm"> * @condition: IO conditions to watch for on @fd</span>
<a name="line-397"></a><span class="cm"> * @function: a #GUnixFDSourceFunc</span>
<a name="line-398"></a><span class="cm"> * @user_data: data to pass to @function</span>
<a name="line-399"></a><span class="cm"> *</span>
<a name="line-400"></a><span class="cm"> * Sets a function to be called when the IO condition, as specified by</span>
<a name="line-401"></a><span class="cm"> * @condition becomes true for @fd.</span>
<a name="line-402"></a><span class="cm"> *</span>
<a name="line-403"></a><span class="cm"> * @function will be called when the specified IO condition becomes</span>
<a name="line-404"></a><span class="cm"> * %TRUE.  The function is expected to clear whatever event caused the</span>
<a name="line-405"></a><span class="cm"> * IO condition to become true and return %TRUE in order to be notified</span>
<a name="line-406"></a><span class="cm"> * when it happens again.  If @function returns %FALSE then the watch</span>
<a name="line-407"></a><span class="cm"> * will be cancelled.</span>
<a name="line-408"></a><span class="cm"> *</span>
<a name="line-409"></a><span class="cm"> * The return value of this function can be passed to g_source_remove()</span>
<a name="line-410"></a><span class="cm"> * to cancel the watch at any time that it exists.</span>
<a name="line-411"></a><span class="cm"> *</span>
<a name="line-412"></a><span class="cm"> * The source will never close the fd -- you must do it yourself.</span>
<a name="line-413"></a><span class="cm"> *</span>
<a name="line-414"></a><span class="cm"> * Returns: the ID (greater than 0) of the event source</span>
<a name="line-415"></a><span class="cm"> *</span>
<a name="line-416"></a><span class="cm"> * Since: 2.36</span>
<a name="line-417"></a><span class="cm"> **/</span>
<a name="line-418"></a><span class="n">guint</span>
<a name="line-419"></a><span class="nf">g_unix_fd_add</span> <span class="p">(</span><span class="n">gint</span>              <span class="n">fd</span><span class="p">,</span>
<a name="line-420"></a>               <span class="n">GIOCondition</span>      <span class="n">condition</span><span class="p">,</span>
<a name="line-421"></a>               <span class="n">GUnixFDSourceFunc</span> <span class="n">function</span><span class="p">,</span>
<a name="line-422"></a>               <span class="n">gpointer</span>          <span class="n">user_data</span><span class="p">)</span>
<a name="line-423"></a><span class="p">{</span>
<a name="line-424"></a>  <span class="k">return</span> <span class="n">g_unix_fd_add_full</span> <span class="p">(</span><span class="n">G_PRIORITY_DEFAULT</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">condition</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">user_data</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<a name="line-425"></a><span class="p">}</span>
<a name="line-426"></a>
<a name="line-427"></a><span class="cm">/**</span>
<a name="line-428"></a><span class="cm"> * g_unix_get_passwd_entry:</span>
<a name="line-429"></a><span class="cm"> * @user_name: the username to get the passwd file entry for</span>
<a name="line-430"></a><span class="cm"> * @error: return location for a #GError, or %NULL</span>
<a name="line-431"></a><span class="cm"> *</span>
<a name="line-432"></a><span class="cm"> * Get the `passwd` file entry for the given @user_name using `getpwnam_r()`.</span>
<a name="line-433"></a><span class="cm"> * This can fail if the given @user_name doesnt exist.</span>
<a name="line-434"></a><span class="cm"> *</span>
<a name="line-435"></a><span class="cm"> * The returned `struct passwd` has been allocated using g_malloc() and should</span>
<a name="line-436"></a><span class="cm"> * be freed using g_free(). The strings referenced by the returned struct are</span>
<a name="line-437"></a><span class="cm"> * included in the same allocation, so are valid until the `struct passwd` is</span>
<a name="line-438"></a><span class="cm"> * freed.</span>
<a name="line-439"></a><span class="cm"> *</span>
<a name="line-440"></a><span class="cm"> * This function is safe to call from multiple threads concurrently.</span>
<a name="line-441"></a><span class="cm"> *</span>
<a name="line-442"></a><span class="cm"> * You will need to include `pwd.h` to get the definition of `struct passwd`.</span>
<a name="line-443"></a><span class="cm"> *</span>
<a name="line-444"></a><span class="cm"> * Returns: (transfer full): passwd entry, or %NULL on error; free the returned</span>
<a name="line-445"></a><span class="cm"> *    value with g_free()</span>
<a name="line-446"></a><span class="cm"> * Since: 2.64</span>
<a name="line-447"></a><span class="cm"> */</span>
<a name="line-448"></a><span class="k">struct</span> <span class="nc">passwd</span> <span class="o">*</span>
<a name="line-449"></a><span class="n">g_unix_get_passwd_entry</span> <span class="p">(</span><span class="k">const</span> <span class="n">gchar</span>  <span class="o">*</span><span class="n">user_name</span><span class="p">,</span>
<a name="line-450"></a>                         <span class="n">GError</span>      <span class="o">**</span><span class="n">error</span><span class="p">)</span>
<a name="line-451"></a><span class="p">{</span>
<a name="line-452"></a>  <span class="k">struct</span> <span class="nc">passwd</span> <span class="o">*</span><span class="n">passwd_file_entry</span><span class="p">;</span>
<a name="line-453"></a>  <span class="k">struct</span>
<a name="line-454"></a>    <span class="p">{</span>
<a name="line-455"></a>      <span class="k">struct</span> <span class="nc">passwd</span> <span class="n">pwd</span><span class="p">;</span>
<a name="line-456"></a>      <span class="kt">char</span> <span class="n">string_buffer</span><span class="p">[];</span>
<a name="line-457"></a>    <span class="p">}</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="line-458"></a>  <span class="n">gsize</span> <span class="n">string_buffer_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="line-459"></a>  <span class="n">GError</span> <span class="o">*</span><span class="n">local_error</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="line-460"></a>  <span class="kt">int</span> <span class="n">errsv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="line-461"></a>
<a name="line-462"></a>  <span class="n">g_return_val_if_fail</span> <span class="p">(</span><span class="n">user_name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<a name="line-463"></a>  <span class="n">g_return_val_if_fail</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="o">*</span><span class="n">error</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<a name="line-464"></a>
<a name="line-465"></a><span class="cp">#ifdef _SC_GETPW_R_SIZE_MAX</span>
<a name="line-466"></a>    <span class="p">{</span>
<a name="line-467"></a>      <span class="cm">/* Get the recommended buffer size */</span>
<a name="line-468"></a>      <span class="n">glong</span> <span class="n">string_buffer_size_long</span> <span class="o">=</span> <span class="n">sysconf</span> <span class="p">(</span><span class="n">_SC_GETPW_R_SIZE_MAX</span><span class="p">);</span>
<a name="line-469"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">string_buffer_size_long</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="line-470"></a>        <span class="n">string_buffer_size</span> <span class="o">=</span> <span class="n">string_buffer_size_long</span><span class="p">;</span>
<a name="line-471"></a>    <span class="p">}</span>
<a name="line-472"></a><span class="cp">#endif </span><span class="cm">/* _SC_GETPW_R_SIZE_MAX */</span><span class="cp"></span>
<a name="line-473"></a>
<a name="line-474"></a>  <span class="cm">/* Default starting size. */</span>
<a name="line-475"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">string_buffer_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="line-476"></a>    <span class="n">string_buffer_size</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
<a name="line-477"></a>
<a name="line-478"></a>  <span class="k">do</span>
<a name="line-479"></a>    <span class="p">{</span>
<a name="line-480"></a>      <span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
<a name="line-481"></a>
<a name="line-482"></a>      <span class="n">g_free</span> <span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
<a name="line-483"></a>      <span class="cm">/* Allocate space for the `struct passwd`, and then a buffer for all its</span>
<a name="line-484"></a><span class="cm">       * strings (whose size is @string_buffer_size, which increases in this</span>
<a name="line-485"></a><span class="cm">       * loop until its big enough). Add 6 extra bytes to work around a bug in</span>
<a name="line-486"></a><span class="cm">       * macOS &lt; 10.3. See #156446.</span>
<a name="line-487"></a><span class="cm">       */</span>
<a name="line-488"></a>      <span class="n">buffer</span> <span class="o">=</span> <span class="n">g_malloc0</span> <span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="o">*</span><span class="n">buffer</span><span class="p">)</span> <span class="o">+</span> <span class="n">string_buffer_size</span> <span class="o">+</span> <span class="mi">6</span><span class="p">);</span>
<a name="line-489"></a>
<a name="line-490"></a>      <span class="n">errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="line-491"></a>      <span class="n">retval</span> <span class="o">=</span> <span class="n">getpwnam_r</span> <span class="p">(</span><span class="n">user_name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">pwd</span><span class="p">,</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">string_buffer</span><span class="p">,</span>
<a name="line-492"></a>                           <span class="n">string_buffer_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">passwd_file_entry</span><span class="p">);</span>
<a name="line-493"></a>      <span class="n">errsv</span> <span class="o">=</span> <span class="n">errno</span><span class="p">;</span>
<a name="line-494"></a>
<a name="line-495"></a>      <span class="cm">/* Bail out if: the lookup was successful, or if the user id can&#39;t be</span>
<a name="line-496"></a><span class="cm">       * found (should be pretty rare case actually), or if the buffer should be</span>
<a name="line-497"></a><span class="cm">       * big enough and yet lookups are still not successful.</span>
<a name="line-498"></a><span class="cm">       */</span>
<a name="line-499"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">passwd_file_entry</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
<a name="line-500"></a>        <span class="p">{</span>
<a name="line-501"></a>          <span class="cm">/* Success. */</span>
<a name="line-502"></a>          <span class="k">break</span><span class="p">;</span>
<a name="line-503"></a>        <span class="p">}</span>
<a name="line-504"></a>      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
<a name="line-505"></a>          <span class="n">errsv</span> <span class="o">==</span> <span class="n">ENOENT</span> <span class="o">||</span> <span class="n">errsv</span> <span class="o">==</span> <span class="n">ESRCH</span> <span class="o">||</span>
<a name="line-506"></a>          <span class="n">errsv</span> <span class="o">==</span> <span class="n">EBADF</span> <span class="o">||</span> <span class="n">errsv</span> <span class="o">==</span> <span class="n">EPERM</span><span class="p">)</span>
<a name="line-507"></a>        <span class="p">{</span>
<a name="line-508"></a>          <span class="cm">/* Username not found. */</span>
<a name="line-509"></a>          <span class="n">g_unix_set_error_from_errno</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">local_error</span><span class="p">,</span> <span class="n">errsv</span><span class="p">);</span>
<a name="line-510"></a>          <span class="k">break</span><span class="p">;</span>
<a name="line-511"></a>        <span class="p">}</span>
<a name="line-512"></a>      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">errsv</span> <span class="o">==</span> <span class="n">ERANGE</span><span class="p">)</span>
<a name="line-513"></a>        <span class="p">{</span>
<a name="line-514"></a>          <span class="cm">/* Cant allocate enough string buffer space. */</span>
<a name="line-515"></a>          <span class="k">if</span> <span class="p">(</span><span class="n">string_buffer_size</span> <span class="o">&gt;</span> <span class="mi">32</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span>
<a name="line-516"></a>            <span class="p">{</span>
<a name="line-517"></a>              <span class="n">g_unix_set_error_from_errno</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">local_error</span><span class="p">,</span> <span class="n">errsv</span><span class="p">);</span>
<a name="line-518"></a>              <span class="k">break</span><span class="p">;</span>
<a name="line-519"></a>            <span class="p">}</span>
<a name="line-520"></a>
<a name="line-521"></a>          <span class="n">string_buffer_size</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
<a name="line-522"></a>          <span class="k">continue</span><span class="p">;</span>
<a name="line-523"></a>        <span class="p">}</span>
<a name="line-524"></a>      <span class="k">else</span>
<a name="line-525"></a>        <span class="p">{</span>
<a name="line-526"></a>          <span class="n">g_unix_set_error_from_errno</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">local_error</span><span class="p">,</span> <span class="n">errsv</span><span class="p">);</span>
<a name="line-527"></a>          <span class="k">break</span><span class="p">;</span>
<a name="line-528"></a>        <span class="p">}</span>
<a name="line-529"></a>    <span class="p">}</span>
<a name="line-530"></a>  <span class="k">while</span> <span class="p">(</span><span class="n">passwd_file_entry</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
<a name="line-531"></a>
<a name="line-532"></a>  <span class="n">g_assert</span> <span class="p">(</span><span class="n">passwd_file_entry</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
<a name="line-533"></a>            <span class="p">(</span><span class="n">gpointer</span><span class="p">)</span> <span class="n">passwd_file_entry</span> <span class="o">==</span> <span class="p">(</span><span class="n">gpointer</span><span class="p">)</span> <span class="n">buffer</span><span class="p">);</span>
<a name="line-534"></a>
<a name="line-535"></a>  <span class="cm">/* Success or error. */</span>
<a name="line-536"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">local_error</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
<a name="line-537"></a>    <span class="p">{</span>
<a name="line-538"></a>      <span class="n">g_clear_pointer</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">g_free</span><span class="p">);</span>
<a name="line-539"></a>      <span class="n">g_propagate_error</span> <span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">g_steal_pointer</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">local_error</span><span class="p">));</span>
<a name="line-540"></a>      <span class="n">errno</span> <span class="o">=</span> <span class="n">errsv</span><span class="p">;</span>
<a name="line-541"></a>    <span class="p">}</span>
<a name="line-542"></a>
<a name="line-543"></a>  <span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="nc">passwd</span> <span class="o">*</span><span class="p">)</span> <span class="n">g_steal_pointer</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">);</span>
<a name="line-544"></a><span class="p">}</span>
</pre></div>
</td></tr></table>
      </div> <!-- /.wrapper -->
    </div>
    <div id="footer" class="footer">
      <p>
        Cppcheck 2.3 - a tool for static C/C++ code analysis<br>
        <br>
        Internet: <a href="http://cppcheck.net">http://cppcheck.net</a><br>
        IRC: <a href="irc://irc.freenode.net/cppcheck">irc://irc.freenode.net/cppcheck</a><br>
      </p>
    </div>
  </body>
</html>
